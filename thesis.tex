\documentclass{jarticle}
\usepackage[dvipdfmx]{graphicx}
\usepackage[dvipdfmx,top=5truemm,bottom=20truemm,left=10truemm,right=10truemm]{geometry}
\usepackage{amsmath,amssymb,mathtools}
\DeclarePairedDelimiter{\norm}{\lVert}{\rVert}
\usepackage{otf}
\graphicspath{{./output/figures/coco_val2017_modular/}{./output/figures/phash_masked_sis/}{./output/phash_masked_sis_eval/}{./output/results/}}

\title{秘密画像共有におけるpHashでのシェア収集を可能にする知覚暗号化の設計}
\newcommand{\thesisyear}{2025年度 卒業論文}
\newcommand{\advisor}{指導教員：［指導教員名］}
\newcommand{\studentname}{玉城洵弥}
\newcommand{\faculty}{工学部 電気電子・情報工学科 情報コース}
\newcommand{\studentid}{1213033903}
\newcommand{\submitdate}{提出日：［YYYY年MM月DD日］}

\setlength{\columnsep}{20pt}
% 丸数字
\newcommand{\marunum}[1]{\textcircled{\scriptsize #1}}
\setlength{\fboxsep}{1pt}

\makeatletter
\renewcommand{\maketitle}{%
  \begin{center}
    \vspace*{\fill}
    {\Large \thesisyear}\\[8pt]
    {\huge\bfseries \@title}\\[24pt]
    \vfill
    {\large \advisor}\\[6pt]
    {\large \submitdate}\\[14pt]
    {\large \studentname}\\[4pt]
    {\large \faculty}\\[4pt]
    {\large \studentid}\\[4pt]
    \vspace*{\fill}
  \end{center}
}
\makeatother

\begin{document}
\begin{titlepage}
\thispagestyle{empty}
\maketitle
\end{titlepage}
\twocolumn

\section*{概要}
画像を平文化せずに類似検索したいという要求に対し、本研究は「pHash のみを公開し視覚情報を開示しない中間状態」を秘密分散で実現する知覚暗号化方式を提案する。収集シェア数に応じて「ノイズのみ」「pHash 符号一致ダミー」「原本」の三段階で情報を開示し、検索と秘匿性を両立させる。
本研究の新規性は、pHash の低周波符号だけを制御したダミー生成と二階層 Shamir による段階開示を統合し、SIS 上で平文 pHash と同等の検索精度を維持しつつ視覚情報を隠蔽する点にある。COCO 派生データ（最大 500 クエリ）で評価した結果、オリジナル画像では「上位1件が必ず正解・上位5件中20\%・上位10件中10\%が正解」で平文とダミーが一致し、全20バリアントでも「上位1件は全て正解・上位5件は86.6\%・上位10件は84.82\%が正解」で一致した。処理時間も 0.58/0.55 ms（オリジナル平文/ダミー）、0.53/0.49 ms（全バリアント平文/ダミー）と同等、復元コストは $k_1$=121 ms、$k_2$=10.2 s に段階化できた。

\section{はじめに}
\subsection{背景}
医療画像や監視映像では「検索はしたいが中身は見せたくない」要求があるが、従来の CBIR は画像や特徴量を平文で保持するため漏洩リスクがある。pHash は軽量で実用的な知覚ハッシュだが、平文で扱えば符号そのものが漏れる。
\subsection{目的}
本研究の目的は、pHash の符号だけを使って類似検索を成立させつつ、視覚情報を厳密に隠蔽する中間状態（k1 開示）を秘密分散で制御することである。既存の SIS は「復元するかしないか」の二択であり、pHash が漏れるが視覚情報は漏れないという状態を段階的に保証する手法は存在しない。
\subsection{貢献}
\begin{itemize}
  \item 低周波符号だけを一致させた pHash 整合ダミーと、二階層 Shamir ($k_1{=}2,k_2{=}4,n{=}5$) による三段階開示モデルを設計し、「pHash のみ開示／視覚情報非開示」を閾値で保証。
  \item pHash 整合ダミーを平文 pHash と同じ API で検索できるようにし、k1 でダミー（pHash のみ開示）、k2 で原本復元という段階開示を masked SIS パイプラインに実装。
  \item COCO 派生データ（500 クエリ、20 変換バリアント）で平文とダミーを比較し、オリジナルで「上位1件は必ず正解・上位5件20\%・上位10件10\%が正解」、全バリアントでも「上位1件は全て正解・上位5件86.6\%・上位10件84.82\%が正解」と一致した。処理時間も平文/ダミーで 0.58/0.55 ms（オリジナル）、0.53/0.49 ms（全バリアント）と同等、復元コストは $k_1$=121 ms, $k_2$=10.2 s で段階化されることを実測した。
\end{itemize}

\section{関連研究}
近年，プライバシ保護を目的とした類似画像検索（Content-Based Image Retrieval; CBIR）の研究は，暗号技術，秘密分散，多人数安全計算（MPC），検索可能暗号（Searchable Encryption; SE）など，多様な手法を基盤として発展してきた。本章では，(1) 類似画像検索の特徴量，（2）秘密分散・MPC によるプライバシ保護 CBIR，（3）検索可能暗号による CBIR，（4）知覚ハッシュ（pHash）に関する研究，の4つの観点から既存研究を整理し，本研究の位置づけを明確にする。

\subsection{類似画像検索に用いられる特徴量：CNN と pHash}
従来の高精度 CBIR では，VGG, ResNet, EfficientNet などの CNN による高次元特徴量（512～4096次元）が一般的に利用されている。しかしこれらは特徴量の次元数が大きく，暗号化や秘密分散を用いたプライバシ保護処理において計算負荷が高くなることが報告されている（Xia et al.\cite{Xia2020}）。一方，pHash（Perceptual Hash）は，低周波領域 DCT の符号パターンから 64bit 程度のハッシュを算出する軽量な知覚特徴量であり，画像の大まかな構造に対してロバストである。しかし，pHash を暗号技術と統合し，プライバシを保ったまま類似検索を可能にする枠組みはほとんど存在していない。

\subsection{秘密分散・MPC を用いたプライバシ保護類似画像検索}
秘密分散や MPC を用いたプライバシ保護 CBIR の研究は活発に行われている。Xia et al.\cite{Xia2020} は，CNN 特徴量を加法的秘密分散により複数サーバへ分割し，サーバ間の MPC によって距離計算を実行する枠組みを提案した。検索処理は暗号化状態で行えるが，高次元特徴量を対象とするため処理が重く，段階的な情報開示は存在しない。また，Zhang et al.\cite{Zhang2024} は Shamir 型秘密分散を用いて CNN 特徴量を分散保持し，復元せずに検索する SS-CNN を提案した。しかしこれも同様に高次元特徴を前提としており，知覚ハッシュのような低次元・符号構造を扱う方式は対象としていない。画像特徴そのものを暗号化状態で計算する研究として，Barni et al.\cite{Barni2010} は JPEG DCT 係数を暗号化し，安全に距離計算を行う手法を提案した。また，Troncoso-Pastoriza et al.\cite{Troncoso2017} はマルチメディア検索のための近似距離 MPC を提供した。しかしこれらは準同型暗号や高度な MPC を必要とし，計算コストが高く実運用は容易でない。さらに重要なのは，上記いずれの研究も (1) シェア数に応じて復元内容が段階的に変化する設計、(2) pHash の符号構造を用いたダミー画像生成、を備えていない点である。

\subsection{検索可能暗号（SE）によるプライバシ保護 CBIR}
検索可能暗号を画像検索に応用した研究も存在する。Tian et al.\cite{Tian2024} は特徴量を暗号化し，ツリー構造インデックスに対して検索を行う SE ベースの CBIR を提案している。また，Xia et al.\cite{Xia2021} は暗号化画像に対して近似検索を行う方式を示した。しかし，これらは (1) 特徴量または画像全体を暗号化する重い方式であり，(2) pHash を用いた軽量検索には向かず，(3) 段階開示モデル（$k_1/k_2$）を持たないという制約がある。したがって，SE は強力だが，軽量で実用的な pHash ベース検索のための暗号設計とは目的が異なる。

\subsection{知覚ハッシュ（pHash）に関する研究}
知覚ハッシュは，画像同士の類似性を測るために広く利用されている。代表的手法として Venkatesan et al.\cite{Venkatesan2000} によるロバストハッシュ生成法が知られており，後続研究でも pHash は著作権管理や偽造検知に利用されてきた。しかし，pHash は本来 認証や重複検出が目的であり，プライバシ保護と結合する研究はほとんど存在しない。特に，(1) pHash の符号構造だけを保ちながら画像を視覚的ノイズに変換する研究、(2) pHash 再現可能なダミー画像を段階的復元モデルに統合した研究、(3) pHash を秘密分散と組み合わせて検索処理に活用する研究は見当たらない。

\subsection{本研究の位置づけ}
以上の比較から，本研究は以下の点で既存研究とは異なる独自の位置づけを持つ。(1) pHash の低周波符号構造のみに基づき、視覚情報を欠く pHash 整合ダミー画像を生成できる点。(2) 秘密分散（SIS）を用い、シェア数に応じて「ノイズ」「pHash 整合ダミー」「原画像」という三段階の開示を実現した点。(3) 検索は軽量な pHash のみで実行し、プライバシは段階的な復元制御によって保証する枠組みを確立した点。著者が調査した範囲では、「pHash × 秘密分散 × 段階開示」を組み合わせた類似画像検索方式はこれまでに提案されておらず、軽量知覚特徴と暗号技術を統合する新しいアプローチを提供する。
さらに，既存研究との対比で強調すべき点は次の2つである。(a) Barni, Xia, Zhang, Troncoso らは「高次元特徴を保持したまま距離計算を安全計算化する」重い路線であり，復元内容を段階開示する設計はない。これに対し本研究は特徴量を pHash に制約し，$k_1$ で pHash のみ開示する極めて軽量な中間状態と，$k_2$ で原本を復元する高コスト状態を分離した。(b) 既存路線では常に安全計算の重さを支払うが，本研究は「検索は軽量 pHash」「復元は閾値到達時のみ」という役割分担で計算量を段階化し，実験でも 0.5 ms/件（検索）と 10 s（完全復元）のコスト差を実証した。このように特徴量次元の削減と段階開示設計により，MPC/SE 系より大幅に小さい計算量で運用できることを第5章の結果（平均 0.5 ms/query）で確認した。

\section{提案手法}
\subsection{記号と定義}
入力画像をグレースケール 32$\times$32 に縮小し DCT を取る。低周波 8$\times$8 ブロック $C_{\text{LF}}$ の符号で 64bit の pHash $b \in \{0,1\}^{64}$ を定義し、$b_i = 1$ は正、0 は負の符号を表す。二階層 Shamir は $n{=}5$, $(k_1,k_2)=(2,4)$ とし、\textbf{$1<k_1<k_2\le n$ で $k_1$ は検索のみ許可、$k_2$ は原画像復元許可の閾値}としてシェア数 $r$ に応じた段階開示を次のように定義する:
\[
  \text{output}(r) = \begin{cases}
    \text{noise} & (r < k_1) \\
    \text{dummy}(b) & (k_1 \le r < k_2) \\
    \text{original} & (r \ge k_2)
  \end{cases}
\]
ここで $\text{dummy}(b)$ は pHash 符号が $b$ と一致するノイズ画像である。
\subsection{三段階開示}
シェア数 $r$ に応じて、$r<k_1$ はノイズ、$k_1 \le r < k_2$ は pHash 符号一致ダミー、$r \ge k_2$ は原本を復元する。
\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/fig_scene_cropped.png}
  \caption{三段階 SIS の概念図（$k_1$:検索のみ，$k_2$:完全復元）}
  \label{fig:three-stage}
\end{figure}
\subsection{pHash 整合ダミー}
ダミー生成の流れを図\ref{fig:dummy-top3} に示す。(1) 元画像を 32$\times$32 に縮小し DCT から target bits（低周波 8$\times$8 の符号）を抽出、(2) 符号が反転しないようマージンを持たせて低周波ブロックを強調（reinforced low-freq）、(3) 高周波をランダムノイズで埋めて逆DCTし 32$\times$32 空間画像を得る。逆DCT後の符号が目標値からずれないよう、低周波振幅を複数回補強し、空間域でのわずかな変動では符号が反転しないマージンを確保する。
\subsection{理論的な安全性と復元不可性}
低周波符号だけを拘束し高周波を完全ノイズ化することで、pHash は一致するが視覚情報は PSNR 10 dB 程度に落ち、画像内容の逆推定は実質困難となる。$k_1$ 未満ではそもそも符号も一致せず平均距離 20.8 とランダムノイズ並みで、pHash 漏洩も発生しない。
\subsection{検索パイプライン}
本稿では masked SIS に特化し、平文 pHash と同一 API で (a) k1 で pHash 整合ダミー検索、(b) k2 で原本復元検索を切り替えるシンプルなパイプラインのみを実装する。シェアは $k_1{=}2,k_2{=}4,n{=}5$ の Shamir で分割し、生成・復元はクライアント側で完結する。

\section{実装}
実装は Python 3 系で構築し、数値計算に NumPy、画像処理に Pillow を用いた。外部依存は最小限とし、DCT/IDCT や Shamir 分散は自前実装で完結させている。
\begin{itemize}
  \item \textbf{pHash 計算}: 32$\times$32 グレースケールへ Bicubic 縮小後、正規直交 DCT-II を行列表現で計算（\texttt{dct2}, \texttt{idct2}）。左上 8$\times$8 の符号を平均閾値で 64bit ベクトルにする（\texttt{compute\_phash}）。
  \item \textbf{ダミー生成}: 64bit 符号を \texttt{\_build\_lowfreq\_from\_bits} で低周波振幅に写像し、\texttt{\_reinforce\_margin} で符号反転を防ぐマージンを強制。高周波は平均0・分散$12^2$ のガウスノイズで埋め、IDCT→0–255 正規化→元サイズへ Bicubic 拡大（\texttt{make\_phash\_preserving\_dummy}）。NumPy の \texttt{default\_rng} でシード制御。
  \item \textbf{二階層 Shamir}: 大素数 $p=2^{521}-1$ 上で Lagrange 補間（\texttt{\_lagrange\_interpolate}）を行う Shamir を実装し、$n=5,k_1=2,k_2=4$ の二層分散（\texttt{TwoLevelShamirScheme}）。秘密は $p$ に収まる長さにチャンク分割して多項式係数を乱数生成し、結合時はチャンク長も保持して復元。
\end{itemize}
可視化は Matplotlib で描画し、精度・時間の集計も同一環境で自動出力している。

\begin{figure}[t]
  \centering
  \includegraphics[width=0.48\textwidth]{output/figures/phash_masked_sis/data00_tuned/stats_phash.png}
  \caption{pHash 距離（ダミー、原本、$<k_1$）}
  \label{fig:mask-phash}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.48\textwidth]{output/figures/phash_masked_sis/data00_tuned/stats_mse.png}
  \caption{PSNR の分布（ダミーと原本）}
  \label{fig:mask-mse}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.46\textwidth]{output/phash_masked_sis_eval/pipeline_top3.png}
  \caption{ダミー生成トップ3（pHash 符号→強調低周波→32$\times$32 空間）}
  \label{fig:dummy-top3}
\end{figure}

\section{実験}
\subsection{設定}
COCO val2017 からシード 2025 でサンプリングした 500 枚を元に、事前に水増しした派生画像セット \texttt{coco2017\_derivatives} を作成し、そのパスを \texttt{mapping.json} にまとめた。各エントリは \texttt{\{id, original, variants\}} で構成され、20 種の決定的変換（JPEG 品質劣化、ガンマ/輝度/コントラスト、回転$\pm$30度、リサンプリング、クロップ、ノイズ、透かし等）を適用したファイルパスを保持する。変換は固定パラメタでオフライン生成し、再現性を確保した。
検索評価では bands=8, $k{=}3,n{=}5$, $\tau{=}8$ を用い、平文 pHash（plain）と k1 ダミー pHash（dummy\_k1）を比較した。オリジナルのみの集計と、上記 20 バリアントをすべて含めた集計の両方を行った。復元評価は最大 50 枚で pHash/PSNR/復元時間を測定した。500 クエリは、全バリアントを均等に含めつつ 1 クエリあたり約 0.5 ms の計算時間で実装検証が可能な規模として設定した。bands=8 は 64bit pHash をバンド分割する標準設定、$\tau{=}8$ は Recall を保ちつつ過剰候補を抑える経験的な閾値である。
\smallskip
ここでの評価指標は次の通りである。適合率@k（Precision@k）は「上位 k 件のうち正解が何件含まれるか」の割合、再現率@k（Recall@k）は「正解全体のうち上位 k 件に何件含まれるか」の割合を表す。上位1件が必ず正解なら適合率@1は100\%となる。
\subsection{復元評価}
ダミー（$k_1$）の pHash 距離は平均 0、$<k_1$ は平均 20.8、ダミー PSNR は平均 10.76 dB と視覚情報がない。復元時間は $k_1$ が平均 121 ms、$k_2$ が平均 10.2 s で閾値ごとにコストが段階化された（図\ref{fig:mask-phash}, \ref{fig:mask-mse}）。$k_2$ が重いのは、元画像を大きな秘密長（64KB）で Shamir 復元するため計算量が増えることによる。
\subsection{pHash 距離分布と精度維持の理由}
dummy\_k1 でも精度が落ちないのは、pHash 符号を一致させているため Hamming 距離のランキングが平文と同一になるからである。$<k_1$ は平均距離 20.8 とランダム同等で候補に入らず、k1 以上の候補は平文と同じ順位付けとなる。
\subsection{検索精度と時間（オリジナル）}
図\ref{fig:search-original-prec}, 図\ref{fig:search-original-time} はオリジナルのみの結果。上位1件の適合率は100\%、上位5件で20\%、上位10件で10\%が正解となり、再現率@10も100\%で plain/dummy\_k1 とも同一、処理時間も 0.581 ms/query（plain）と 0.548 ms/query（dummy\_k1）でほぼ同等だった。

\begin{figure}[t]
  \centering
  \includegraphics[width=0.48\textwidth]{output/results/masked_phash_eval_figs/precision_summary.png}
  \caption{Precision（平均値、オリジナルのみ）}
  \label{fig:search-original-prec}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.48\textwidth]{output/results/masked_phash_eval_figs/time_summary.png}
  \caption{Latency（平均値、オリジナルのみ）}
  \label{fig:search-original-time}
\end{figure}

\subsection{バリアント別の精度と時間}
\texttt{--per\_variant\_plots} で全20バリアントを自動ループし、平文 vs ダミーの精度と時間を集計した。全バリアントの平均で「上位1件は全て正解・上位5件は86.6\%・上位10件は84.82\%が正解」、再現率@10は 42.41\% と平文／ダミーが一致し、処理時間も 0.527 ms/query（plain）と 0.494 ms/query（dummy\_k1）で差が小さい（図\ref{fig:search-all-prec}, \ref{fig:search-all-time}）。

\begin{table}[t]
  \centering
  \caption{評価した20バリアントの例（mapping.json）}
  \small
  \begin{tabular}{p{3.9cm}p{3.9cm}}
    \hline
    フォトメトリック系 & 幾何・ノイズ系 \\
    \hline
    brightness\_minus25 & rotate\_plus30\_black \\
    contrast\_plus30 & rotate\_minus30\_black \\
    gamma\_0\_7, gamma\_1\_3 & crop\_balanced\_30 \\
    jpeg60, jpeg75, jpeg\_q50\_subs & perspective\_trapezoid \\
    webp\_q70 & resample\_bilinear\_nearest \\
    watermark\_logo & gaussian\_sigma10,15 \\
    & salt\_pepper\_5, motion\_blur \\
    & occlusion\_rectangle \\
    \hline
  \end{tabular}
\end{table}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.48\textwidth]{output/results/masked_phash_eval_all_figs/precision_summary_all_variants.png}
  \caption{Precision@1（バリアント別、plain vs dummy\_k1）}
  \label{fig:search-all-prec}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.48\textwidth]{output/results/masked_phash_eval_all_figs/time_summary_all_variants.png}
  \caption{Latency（バリアント別、plain vs dummy\_k1）}
  \label{fig:search-all-time}
\end{figure}

\section{考察}
ダミーは視覚情報を開示せずに pHash を一致させ、平文 pHash と同等の検索精度・時間を維持できた。一方で以下の安全性・限界を整理する。
\begin{itemize}
  \item pHash 整合ダミーは高周波を完全ノイズ化し、PSNR 10 dB 台で視覚的情報が消えるため逆推定は実質困難。pHash のみが漏れるが、符号64bitだけでは画像内容を復元するのは非現実的。GAN などによる復元も高周波ノイズ主体のため困難と考えられる。
  \item $k_1$ 未満では pHash も一致せず距離平均 20.8 とランダムノイズ並みで、pHash 漏洩も発生しない。$k_1$/$k_2$ で権限分離し、k1 は検索専用、k2 は復元許可の運用が可能。
  \item アクセスパターンは固定長バッチとダミーで平滑化するが完全には隠せない。VOPRF/TEE の導入や固定サーバ集合での一律送信でさらなる緩和が必要。
  \item pHash の弱さ（大回転や 30\% 超の切り抜きで符号が崩れる）は残る。必要に応じて CNN 特徴や多視点 pHash とのハイブリッド化を検討する。
\end{itemize}

\section{おわりに}
pHash 符号一致ダミーと二階層 Shamir に基づく三段階開示モデルを提案し、SIS 上で平文を開示せずに類似検索を実現した。平文と同等の検索性能を保ちつつ、復元コストを閾値で段階化できることを確認した。本研究は「画像を見せずに画像を検索する」という従来は両立しなかった要請に対し、pHash の知覚特性と SIS の暗号特性を統合することで実装可能な解法を提示した点に意義がある。今後は (1) 10万件規模へのスケールと索引・通信コストの評価、(2) pHash と CNN 特徴のハイブリッド化や頑健な知覚ハッシュとの接続、(3) クエリごとの最適 $\tau$ を動的に調整する閾値制御、(4) アクセスパターン秘匿のさらなる強化（VOPRF/TEE）を進める。

\begin{thebibliography}{99}
\bibitem{Xia2020}
Z. Xia, X. Wang, L. Yao, et al., ``A privacy-preserving CBIR scheme based on secret sharing,'' \textit{IEEE Access}, 2020.
\bibitem{Zhang2024}
C. Zhang, Y. Li, and Q. Liu, ``SS-CNN: Secret sharing based secure image retrieval,'' \textit{Journal of Visual Communication and Image Representation}, 2024.
\bibitem{Barni2010}
M. Barni, P. Failla, R. Lazzeretti, et al., ``A privacy-preserving framework for JPEG-based image retrieval,'' \textit{IEEE Transactions on Information Forensics and Security}, 2010.
\bibitem{Troncoso2017}
J. R. Troncoso-Pastoriza, S. Katzenbeisser, and M. Celik, ``Privacy-preserving approximate search for multimedia,'' \textit{IEEE Transactions on Circuits and Systems for Video Technology}, 2017.
\bibitem{Tian2024}
Y. Tian, X. Wang, and D. He, ``Secure image retrieval based on feature index tree searchable encryption,'' \textit{Information Sciences}, 2024.
\bibitem{Xia2021}
Z. Xia, Y. Zhu, X. Sun, and Q. Wang, ``Searchable image encryption for privacy-preserving CBIR,'' \textit{IEEE Access}, 2021.
\bibitem{Venkatesan2000}
R. Venkatesan, S.-M. Koon, M. Jakubowski, and P. Moulin, ``Robust image hashing,'' in \textit{Proc. IEEE ICIP}, 2000.
\end{thebibliography}

\end{document}


