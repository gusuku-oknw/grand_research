\documentclass[a4paper,10pt,report]{jsbook}

\usepackage[utf8]{inputenc}
%\usepackage[T1]{fontenc}
%\usepackage{newpxmath, newpxtext}
\usepackage{amsmath,amssymb}
\usepackage[bold]{otf}
\usepackage{titlesec}
\usepackage{cite}
\usepackage{url}
\usepackage{colortbl}
\usepackage[dvipdfmx]{graphicx}
\usepackage{mathtools}
\usepackage{array}
\DeclarePairedDelimiter{\norm}{\lVert}{\rVert}
\newcommand{\sgn}{\text{sgn}}
\newcommand{\abs}{\text{abs}}
\newcommand{\refsiz}{\fontsize{6pt}{0cm}\selectfont}%for determining

\usepackage[dvipdfmx,top=25truemm,bottom=30truemm,left=30truemm,right=30truemm]{geometry}
\graphicspath{{./output/figures/coco_val2017_modular/}{./output/figures/phash_masked_sis/}{./output/phash_masked_sis_eval/}{./output/phash_masked_sis_eval/figures/}{./output/results/}}

\title{秘密画像共有におけるpHashでのシェア収集を可能にする\\
知覚暗号化の設計}

\newcommand{\thesistype}{2025年度 卒業論文}
\newcommand{\studentname}{玉城洵弥}
\newcommand{\studentid}{1213033903}
\newcommand{\advisor}{清水 恒輔}
\newcommand{\faculty}{工学部電気電子・情報工学科情報コース}
\newcommand{\university}{岐阜大学}

\author{氏名：\studentname\\学生番号：\studentid\\指導教員：\advisor}
\date{2026年2月6日}

\newcommand{\titlesize}{\fontsize{16pt}{20pt}\selectfont}

\makeatletter
\renewcommand{\maketitle}{
\thispagestyle{empty}
\begin{center}
\phantom{}
\vskip 36pt
{\titlesize \thesistype \par}
\vskip 36pt
{\titlesize\@title\par}
\vskip 266pt
{\titlesize\@author\par}
\vskip 36pt
{\titlesize{\faculty}\par}
\vskip 36pt
{\titlesize{\university}\par}
\vskip 24pt
{\fontsize{14pt}{18pt}\selectfont\@date\par}
\end{center}
\newpage
}
%TOCも含めて，欧文フォントをRomanに変更
\let\originall@chapter\l@chapter
\def\l@chapter#1#2{\originall@chapter{{\bfseries\rmfamily #1}}{\bfseries\rmfamily#2}}
\makeatother

\titleformat{\chapter}[display]{\normalfont\huge\bfseries}{\chaptertitlename\ \thechapter\ 章}{20pt}{\Huge}
\titleformat{\section}{\normalfont\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\normalfont\bfseries}{\thesubsubsection}{1em}{}

\renewcommand{\baselinestretch}{1.3}%行間
\begin{document}
\maketitle
\tableofcontents
\listoffigures
\listoftables

\chapter*{概要}
医療画像に代表される機微情報は，患者のプライバシーに直結するため，極めて高度な安全管理が求められる．
現状，国内の多くの医療機関では院内サーバ（オンプレミス）での管理が一般的であるが，これは災害時のデータ消失リスクや管理コストの増大といった単一障害点の課題を抱えている．
一方で，可用性向上を目的としたクラウド移行においては，特定の事業者にデータ原本を委ねることによる情報漏えいやプライバシー侵害の懸念が障壁となっている．
したがって，特定の管理主体に依存せず，複数のサーバへ地理的・管理的に分散して保存することで，可用性と機密性を同時に担保するアプローチが望ましい．


そのための有力な技術として，画像を複数のシェアへ分割して分散保持し，所定数（$k$-of-$n$）のシェアが揃った場合にのみ復元を可能とする秘密画像共有（Secret Image Sharing; SIS）が注目されている．これらは，保管先の分散や合意復元といった運用要件を自然に満たし，単一点の侵害に対する耐性を高める枠組みとして位置づけられる．
本研究は，このように分散保持によって機密性を高めたデータ集合に対し，秘匿状態を維持したまま（原画像を復元することなく）類似画像検索を実現することを目的とする．


従来の類似画像検索（Content-Based Image Retrieval; CBIR）は，画像特徴量をサーバ側に保持し，平文特徴量間の比較により検索を行う構成が一般的である．
しかしこの構成は，復元可能なデータを一箇所に集約するため侵害時のリスクが大きく，さらに検索処理（ログやアクセスパターン）を通じて画像間の類似関係までもが漏えいし得るという構造的な課題がある．


したがって，医療画像のような機微画像を対象とするCBIRにおいては，
「画像を復元可能な状態で一箇所に集約しない」ことと「類似性の評価過程からの漏えいを抑制する」ことを同時に満たす枠組みが求められる．


そこで，これらの要件を満たすため，分散保持されたシェアから直接得られる情報に基づいて候補を絞り込み，必要最小限の情報開示で類似性を評価することで，検索機能とプライバシー保護の両立を目指す．


一般に，SISのシェアは暗号化画像のようにランダムに見えるため，原画像に対して用いられる従来のCBIR手法をそのまま適用できない．


一度原画像に復元すれば検索は可能であるが，その都度，閾値以上のシェア収集（＝閲覧権限の承認・行使）と復元計算を要するため，コストや権限管理の観点で課題が残る．
加えて，類似検索には比較のための情報開示が不可欠であるが，復元／非復元かの二択では「参照のための検索は許可したいが，原画像の閲覧・保存は許可しない」という要件を満たすことが原理的に困難である．


以上を踏まえ，本研究では「検索のみ許可／閲覧は禁止」という中間状態を導入し，収集したシェア数に応じて可能な処理（権限）を段階的に切り替える方式を提案する．これにより，機微画像を平文化せずに検索可能性を確保しつつ，不要な情報開示を抑制することを目指す．


シェアのまま高速に類似性判定を行うために，知覚ハッシュの一種であるpHashを用いる．pHashは画像を低次元のビット列に写像し，Hamming距離（XORとビットカウント）で高速比較できるため，大規模データベースに対しても検索コストと保存コストを小さくできる．


前述の通り，SISのシェアはランダムな値を持つため，シェア画像にそのままpHashを適用しても元画像の類似性は保証されない．
そこで本研究では，pHashが主に低周波構造に依存する点に着目し，閲覧に資する高周波成分は劣化させつつpHashに必要な低周波符号を一致させることで，pHashの検索精度を落とさずにSISフレームワーク上で検索を可能にする知覚暗号化方式を設計した．


具体的には，本研究はSISにおける多層（multi-level）／多閾値（multi-threshold）アクセス構造に基づき，収集したシェア数$r$に応じて開示する情報（出力）を以下の3段階（Level 0〜2）のように設定する．
\begin{itemize}
  \item \textbf{Level 0 ($r < k_1$):} 閲覧・検索ともに不可（ノイズ画像）．
  \item \textbf{Level 1 ($k_1 \le r < k_2$):} 類似検索のみ許可（pHash整合ダミー画像）．
  \item \textbf{Level 2 ($k_2 \le r$):} 原画像の閲覧・復元を許可．
\end{itemize}

特にLevel 1においては，$k_1$到達時に検索に必要な低周波符号が平文pHashと一致するように合成したダミー画像（pHash整合ダミー）を返す．
このダミーは，高周波成分をノイズ化して輪郭・文字・顔などの可読性を低下させ，内容推定に資する手掛かりを弱める一方で，検索に必要な低周波符号は保持する．


COCO派生データ（最大500クエリ）を用いた評価実験の結果，検索性能は Precision@K（検索結果上位K件に含まれる正解の割合）と Recall@K（正解集合のうち上位K件で回収できた割合）で評価した．
元画像では Precision@1=100\%となり，平文pHashと同等の検索結果を維持した．
また，回転・切り抜き等の20種類の変換画像を含む条件でもPrecision@1=100\%，Precision@5=86.6\%，Precision@10=84.82\%であり，平文との差は小さかった．


処理時間も約0.5ms/件と平文と同等であり，復元時間は$k_1$到達時に121ms，$k_2$到達時に10.2sとなり，段階化できた．

\chapter{はじめに}

\section{背景}
医療画像や監視映像，個人写真などの機微画像には，画像内容そのものを広く開示することなく，
類似事例を検索して診断・治療方針の検討，臨床教育，研究用途に活用したいという要求がある．
実際，医療分野ではContent-Based Medical Image Retrieval（CBMIR/CBIR）が，
症例参照型の意思決定支援や教育支援のための基盤技術として位置づけられてきた\cite{muller2020mir,sotomayor2021cbmir,su2007decision_support}．
一方で，こうした画像は患者情報や個人情報と結びつくことが多く，
「検索できる」こと自体が情報露出の入口になり得るため，利便性とプライバシーの両立が課題となる．

従来のコンテンツベース画像検索（Content-Based Image Retrieval; CBIR）は，
検索精度と運用容易性を優先し，画像特徴量（埋め込みやハッシュ等）をクラウド上のサーバで保持・照合する構成が一般的である．
しかし本研究では，サーバ管理者による目的外の閲覧や，外部攻撃者によるデータ窃取のリスクを考慮し，サーバを完全には信頼しない脅威モデルを採用する．
具体的には，サーバ（またはサーバへの侵入者）は計算手順（プロトコル）には従う一方で，保持データや処理結果から画像内容の推測を試みる脅威（semi-honest／honest-but-curious）を想定する．
以下では，このようなサーバ運用主体をクラウドサービス提供者（Cloud Service Provider; CSP）と呼ぶ．
この状況では，(1) サーバが保持する特徴量，(2) 照合の中間結果や順位，(3) アクセスパターンやログといった周辺情報が攻撃面となり得る．
これらが漏えいした場合，画像内容・属性の推測や，近傍関係（どの画像がどれに似ているか）に基づくメタデータ露出が生じ得るため，
CSP を含むサーバ側を完全には信頼しない前提でのプライバシー保護 CBIR が研究されてきた\cite{xu2017ppcbir_cloud,ferreira_iescbir}．

本研究では，さらに「サーバに原画像を置かない」だけでなく，
画像そのものを秘密画像共有（Secret Image Sharing; SIS）により分散保持した画像集合を検索対象とする状況を扱う．
SISは画像を$n$個のシェアに分割し，所定数（閾値）以上のシェアが揃った場合にのみ復元できる一方，
閾値未満では原画像に関する意味情報が得られないよう設計される（閾値型SIS）．
脅威モデルとしては，サーバ（および一部の保持者）はプロトコルには従うが，
保持データや観測可能な計算結果から推測を試みるsemi-honestを想定し\cite{semi_honest_katz}，
加えて複数主体が結託して観測情報を統合する可能性も考慮する．
このとき，閾値未満のシェア画像集合からは原画像を復元できないことを安全性の前提とする．

しかし，SISを前提にすると検索の実現は自明ではない．
一般的なSISでは，各シェアが単独では意味情報を与えないよう生成されるため，
原画像を前提とするCBIR（特徴抽出・比較）をシェアに直接適用しても，
原画像間の類似関係を反映した比較結果は得られない．
したがって素朴な運用としては，検索の都度，閾値以上のシェアを収集して復元（平文化）し，
その後に特徴抽出・類似度計算を行う手順が必要となる．
ところが，この「復元してから検索」という手順は，単に計算・通信コストが増大するだけでなく，セキュリティおよび運用上の大きな課題を抱える．
例えば，広域監視や医療連携において「該当データが存在するか（ヒットするか）」をスクリーニングしたい段階で，無関係なデータも含めて全て復元（閲覧）しなければならない構成は，プライバシー侵害のリスクを不要に拡大させてしまう．
また，常時復元処理を伴う検索は，リアルタイム性が求められる場面では応答速度の致命的なボトルネックとなる．
したがって，「閲覧は許可しないが検索のみ行いたい」という要件を，
復元を前提とする設計のみで満たすことは難しい．
このため，秘密分散による保護状態を維持したまま，検索に必要な情報のみを制御して利用可能とする検索方式が必要となる．

本研究では，検索の特徴量として知覚ハッシュ（perceptual hash; pHash）を採用する．
pHashは画像を小サイズに正規化した後に離散コサイン変換（Discrete Cosine Transform; DCT）を適用し，低周波成分から64bitのハッシュ値（ビット列）を生成することで，
軽量なビット列比較（Hamming距離：XORとビットカウント）で高速に近似類似検索を行える\cite{farid2021phash}．
このような低次元・ビット演算中心の比較は，大規模データベースに対しても計算資源と保存容量を抑えやすく，
本研究が想定する「サーバを信頼しない」環境下での実装・運用上の利点が大きい．
一方で，知覚ハッシュは，攻撃者が生成した任意のクエリとハッシュとの照合結果（距離や合否）を反復的に取得することで，逆像を推定する判定器（オラクル）として悪用され得ること，
また実運用で用いられるPhotoDNA/PDQ/NeuralHash等に対する脅威モデル・攻撃評価が議論されていることが報告されている\cite{jain2022usenix_phash,pha_robustness_2024}．
したがって，検索機能を提供する場合でも，どの情報をどの段階で開示するかは慎重に設計しなければならない．

以上より，本研究の課題は次の3点である．
\begin{enumerate}
  \item SIS により保護された画像集合に対し，秘密分散による保護状態を維持したまま検索を可能にすること．
  \item 検索に必要な情報のみを，収集シェア数に応じて段階的に制御して開示すること．
  \item pHash に基づく高速な類似検索を成立させ，実装・運用上の負担を抑えること．
\end{enumerate}

\section{目的}
本研究が対象とするのは，SISで分散保持された機微画像集合に対し，原画像を復元（平文化）せずに類似検索を成立させたい状況である．
類似検索を行う以上，検索用表現（特徴量やハッシュ値など）を比較に用いること自体は避けられない．
しかし，サーバを信頼しない（semi-honest：プロトコルには従うが，観測できた情報から追加推測を試みる）環境では，上記オラクルが検索結果を反射的に，探索・推測し得ることが考えられる，
検索用表現を無条件に露出させる設計は望ましくない\cite{farid2021phash,jain2022usenix_phash}．
一方で，SISの素朴な運用として「検索のたびに閾値以上のシェアを収集して復元してからCBIRを実行する」手順を採ると，
復元処理に計算・通信コストが発生するだけでなく，復元許可（閲覧権限）と所定数のシェア収集が前提となるため，
「閲覧は許可しないが検索だけ行いたい」という要求と整合しない．

これらの要件を同時に満たすため，本研究は検索可能性と閲覧可能性を同一視せず，
開示レベルを三段階に分離して制御する方式を確立することを目的とする．
総シェア数を$n$，収集したシェア数を$r$とし，二つの閾値$k_1,k_2$（$k_1<k_2$）を設ける．
以上を踏まえ，本研究は収集シェア数 $r$ に応じて開示レベルを次の三段階に分離して制御する．
\begin{enumerate}
  \item[Level 0:] $r<k_1$ のとき，検索に資する情報は開示せず，通常の SIS シェアのみを保持する．
  \item[Level 1:] $k_1 \le r < k_2$ のとき，検索のみを許可し，検索に必要な情報だけを含む検索専用出力を開示する．
  \item[Level 2:] $r \ge k_2$ のとき，原画像の復元を許可する．
\end{enumerate}

Level 1では，pHash計算で参照される低周波成分に対応する符号が平文pHashと一致するように合成したダミー画像
（pHash整合ダミー）を出力する．
pHash整合ダミーは検索のための一致（pHashの一致）を満たす一方で，
輪郭・文字・顔など内容推定に資する視覚情報は高周波成分のマスク／ノイズ化により意図的に劣化させ，
閲覧可能性（内容の可読性）を抑制する．
すなわち本研究のLevel 1は，「検索の成立」と「閲覧の抑止」を両立させるために導入される中間段階である．

\section{貢献}
本研究は，秘密画像共有（Secret Image Sharing; SIS）で分散保持された画像集合に対して，
原画像の復元（平文化）を前提とせずに類似画像検索を成立させるための設計指針と実装・評価を提示する．
本研究の貢献は，次の三つの成果として整理できる．

まず，検索可能性と閲覧可能性を混同せずに制御するための段階開示モデルを提示した．
具体的には，シェア収集数$r$に応じて開示レベルを切り替える枠組みを定義し，
$r<k_1$では検索に資する情報を開示せず（Level 0），$k_1\le r<k_2$では検索のみを許可する出力（Level 1）を開示し，
$r\ge k_2$で初めて復元（Level 2）を許可するという二つの閾値$k_1,k_2$に基づくアクセス構造として定式化した．
これにより，「検索だけ許可したい」という運用要求を，復元許可（閲覧許可）と切り離して扱えることを明確化した．

次に，Level 1の検索専用出力として，pHash検索に必要な情報のみを保持するpHash整合ダミーを設計した．
本設計は，pHashが参照する低周波成分に対応する符号を一致させる一方で，
輪郭・文字・顔など内容推定に資する視覚情報を高周波成分のマスク／ノイズ化により意図的に劣化させることで，
照合（検索）の可否と視覚的内容の復元（閲覧）を分離することを狙う．
さらに，既存のpHash計算（64bitハッシュ値（ビット列）の生成とHamming距離比較）と同一の入出力で扱えるように構成し，
既存の検索実装へ組み込みやすい形に整理した．

最後に，提案した段階開示方式をSIS検索パイプラインとして実装し，COCO派生データを用いて有効性を実験的に示した．
原画像とpHash整合ダミーの検索結果（Precision@k）および処理時間を比較し，
検索精度の維持と計算コストの妥当性を確認した．
また，Level 1（検索）からLevel 2（復元）への切り替えに伴う処理時間の増加を測定し，
段階開示として運用上分離できることを示した．

\chapter{関連研究}
本研究は，秘密画像共有（Secret Image Sharing; SIS）により分散保持された画像集合に対して，
原画像を復元（平文化）せずに類似画像検索を成立させることを目的とする．
第1章では背景と課題設定を述べたため，本章では提案法の位置づけに必要な既存研究を整理する．
具体的には，類似画像検索で用いられる特徴量（深層特徴と知覚ハッシュ），
暗号・秘密分散・多人数安全計算（Multi-Party Computation; MPC）によるプライバシー保護検索，
検索可能暗号（Searchable Encryption; SE）を用いた検索，
知覚ハッシュ（pHash）とその安全性・運用上の観点から関連研究を概観する．

\section{類似画像検索に用いられる特徴量：深層特徴と知覚ハッシュ}
高精度な類似画像検索では，Convolutional Neural Network（CNN）に基づく埋め込み（深層特徴）が広く用いられてきた．
VGG（Visual Geometry Group）やResNet（Residual Network）等で抽出される特徴量は，画像の意味的類似をよく捉える一方で，次元数が数百から数千規模に及ぶことが多く，
暗号化や秘密分散，MPCを併用して距離計算を行う場合，計算量・通信量が支配的になりやすいことが報告されている\cite{Xia2020}．
このため，プライバシー保護を要する設定では，コストを抑えるために次の工夫が検討されている．
\begin{itemize}
  \item 特徴量自体を低次元化する．
  \item 距離計算を近似・簡略化する．
  \item 特徴量をバイナリ化し，ビット演算中心で照合する．
\end{itemize}

この文脈で，知覚ハッシュ（perceptual hash）は，画像を短いビット列へ写像し，
Hamming距離により高速比較できる点で実装・運用上の利点が大きい．
とりわけpHashは，画像を小サイズに正規化した後にDCTを適用し，低周波成分の符号から
64bit程度のハッシュ値（ビット列）を生成する軽量手法として広く知られている\cite{Venkatesan2000,farid2021phash}．
一方で，知覚ハッシュは「類似性を保存する」設計であるため，照合の可否や距離が外部から反復的に観測できる状況では，
検索機能がオラクルとして悪用される危険生がある（第\ref{sec:phash_related}節参照）．
したがって，pHashの軽量性を活かしつつ，どの情報をどの段階で開示するかまで含めた設計が重要となる．

\section{秘密分散・MPCを用いたプライバシー保護検索}
秘密分散やMPCを用いたプライバシー保護型の類似検索では，
特徴量（多くはCNN特徴）を暗号化・分散保持し，サーバ間で安全に距離計算を行う枠組みが提案されてきた．
例えば，クラウド上の類似検索において，特徴量を秘匿化したまま比較処理を実行する方式が検討されている\cite{Xia2020}．
また，準同型暗号やMPCを用いて距離計算・近傍探索を実現する研究も多数存在し，
暗号化ドメインや秘匿状態での比較処理そのものは可能になりつつある\cite{Barni2010}．

しかし，既存研究の多くは「特徴量ベクトル（平文特徴の秘匿表現）」を前提に，
秘匿距離計算をどう成立させるかに主眼が置かれている．
これに対して本研究は，
\begin{itemize}
  \item 検索対象が SIS により「画像そのもの」として分散保持されていること
  \item 運用上「検索のみ許可／閲覧は禁止」という中間状態を明確に分離したいこと
  \item そのために検索用の出力形式自体を設計し直す必要があること
\end{itemize}
以上の設計により，本研究は機微画像の保護と画像検索の両立という課題に対し，SISの枠組みを用いた具体的な解決策を確立した．

特に，SISでは閾値未満のシェア集合から意味情報が得られないよう設計されるため，
復元を前提とする運用では「検索のたびに復元してから特徴抽出」という手順になりやすく，
計算・通信コストと権限制御の両面で負担が大きい．
このため，SISの保護状態を維持したまま検索を成立させるには，距離計算の安全化だけでなく，
「検索に必要な情報だけを制御して利用可能にする」ための表現設計が別途必要となる．


\section{段階開示・多層SISに関する研究}
\label{sec:related_multilevel}

秘密分散（Secret Sharing）は，単一の$(k,n)$閾値型に限らず，
一般のアクセス構造を実現する枠組みや，多層（階層）構造を扱う拡張が研究されている．
たとえばBenaloh--Leichterは，任意の単調アクセス構造を単調論理式として表現し，
それに対応する秘密分散を構成する一般化手法を与えた~\cite{benaloh1988gss}．
またTassaは，参加者が階層化された状況で，上位層の参加者を少数含むだけで復元可能になるような
階層閾値アクセス構造に対して，理想的な秘密分散を設計している~\cite{tassa2007hierarchical}．

一方，画像を対象とする秘密画像共有（Secret Image Sharing; SIS）や視覚暗号（Visual Cryptography; VC）では，
シェア数の増加に伴って復元画像の視認性が向上する「progressive（段階的）復元」を目的とする系譜がある．
VCの代表例としてNaor--Shamirの視覚暗号が知られ~\cite{naor1994visualcrypto}，
その拡張としてカラー画像に対するprogressive視覚暗号も提案されている~\cite{jin2005progressive_color}．
またSIS側でも，より多くのシェアを用いるほど復元品質が向上するPSIS（Progressive SIS）を扱う研究が報告されている~\cite{xiong2021cppsis}．
これらの体系的整理として，視覚暗号を扱う書籍も存在する~\cite{liu2015visualcrypto_book}．

本研究が狙うのは，復元品質が連続的に向上すること自体ではなく，
「検索専用の出力」と「閲覧可能な復元画像」を離散的に分離し，
閾値に応じて開示する情報の種類を切り替える点にある．
特に，知覚ハッシュ（pHash）と整合する検索専用出力（pHash整合ダミー）を構成して検索を成立させつつ，
閲覧につながる視覚情報を抑制する設計は，少なくとも上記の多層秘密分散／progressive SIS・VCの主要文献では明示的に議論されていない．

\section{検索可能暗号（SE）によるプライバシー保護検索}
検索可能暗号（SE）を用いて，暗号化したまま検索を行う研究も存在する．
画像検索では，特徴量を暗号化してインデックスを構築し，暗号化状態で検索を行う方式が提案されている\cite{Tian2024}．
SE系の枠組みは「検索はできるがデータ内容は隠す」という要請に整合しやすい反面，
実装上は暗号化インデックスの構築・更新，検索トークン生成，アクセスパターン漏えい対策など，
運用・性能の論点が複雑化しやすい．
また，SISのように画像自体が分散保持される状況や，
閾値に応じて「検索専用出力／復元画像」を切り替える段階開示の要請を前提に設計された研究は多くない．

\section{知覚ハッシュ（pHash）に関する研究}
\label{sec:phash_related}
知覚ハッシュ（ロバストハッシュ）は，重複検出，改ざん検知，著作権管理等の文脈で研究・利用されてきた\cite{Venkatesan2000}．
pHashはその代表例として広く普及しているが，
本来は「類似性を保存するハッシュ値（ビット列）」であるため，暗号学的ハッシュのような一方向性や耐推測性を保証するものではない\cite{phash_hackerfactor}．
このため，照合結果（距離やヒットの有無）を外部から反復的に観測できる環境では，
検索機能がオラクルとして悪用されるという安全性・運用上の注意点が指摘されている\cite{jain2022usenix_phash}．

以上を踏まえると，pHashをプライバシー保護設定で用いる場合は，
単に「pHashを暗号化して比較する」だけでなく，
どの情報をどの段階で開示するか（検索の可否と閲覧の可否をどう分離するか）まで含めて
設計する必要がある．
本研究は，SISという「復元に閾値を要する分散保持」を前提に，
pHash整合な検索専用出力を導入して段階開示を実現する点に特徴がある．

\section{Shamir秘密分散の基礎}
\label{sec:shamir_basics_moved}

本節では，本研究で用いるShamir秘密分散の基本事項を整理する．
Shamir秘密分散は，有限体上の多項式補間に基づく\((k,n)\)閾値方式であり，
「任意の\(k\)個のシェアからは秘密を復元できるが，\(k-1\)個以下からは秘密に関する情報が得られない」
という情報理論的性質をもつ\cite{shamir1979}．
本研究ではこの性質を「閾値未満では復元できない」というアクセス制御の基盤として用いる．

\subsection{Shamir秘密分散の定義}
\label{subsec:shamir_def}
総シェア数を\(n\)，閾値を\(k\)（\(1\le k\le n\)）とする．
素数\(p\)を法とする有限体\(\mathbb{F}_p\)を用い，
秘密（共有したい値）を\(s\in\mathbb{F}_p\)として表す．
Shamir秘密分散では，次数\(k-1\)以下の多項式
\begin{equation}
  f(x)=a_0 + a_1 x + a_2 x^2 + \cdots + a_{k-1}x^{k-1}
  \quad (a_j\in\mathbb{F}_p)
  \label{eq:shamir_poly}
\end{equation}
を構成し，定数項を秘密に一致させる：\(a_0 := s\)．
係数\(a_1,\dots,a_{k-1}\)は\(\mathbb{F}_p\)上で一様にランダムに選ぶ．

\subsection{シェア生成手順}
\label{subsec:share_generation_def}
参加者（保持者）\(i\in\{1,\dots,n\}\)に配布するシェアは，多項式の評価値として与える．
評価点は0を避け，互いに相異なる\(x_i\in\mathbb{F}_p\setminus\{0\}\)を選ぶ
（本研究では実装の単純性のため \(x_i:=i\) を用いる）．
このとき各参加者\(i\)に配布するシェアは
\begin{equation}
  \mathrm{share}_i := (x_i, y_i), \qquad y_i := f(x_i)\in\mathbb{F}_p
  \label{eq:share_calculation}
\end{equation}
である．
すなわち，秘密は多項式の定数項として埋め込まれ，シェアはそのサンプル点として配布される．

\subsection{復元手順（Lagrange補間）}
\label{subsec:lagrange_interpolation}
任意の\(k\)個のシェア\(\{(x_{i_1},y_{i_1}),\dots,(x_{i_k},y_{i_k})\}\)が与えられると，
次数\(k-1\)以下の多項式は一意に定まり，Lagrange補間により\(f(0)=s\)を直接計算できる．
Lagrange基底多項式を
\begin{equation}
  \ell_j(x)=\prod_{\substack{m=1\\ m\ne j}}^{k}\frac{x-x_{i_m}}{x_{i_j}-x_{i_m}}
  \quad (\bmod\ p)
\end{equation}
とすると，
\begin{equation}
  f(x)=\sum_{j=1}^{k} y_{i_j}\,\ell_j(x)\quad (\bmod\ p)
\end{equation}
であり，特に復元したい秘密は
\begin{equation}
  s=f(0)=\sum_{j=1}^{k} y_{i_j}\,\lambda_{i_j}\quad (\bmod\ p),
  \qquad
  \lambda_{i_j}:=\prod_{\substack{m=1\\ m\ne j}}^{k}\frac{-x_{i_m}}{x_{i_j}-x_{i_m}}
\end{equation}
として得られる．
本研究の実装では，除算は\(\mathbb{F}_p\)上の逆元計算（拡張Euclid等）により行い，
復元はLagrange補間を用いて実装する．

\subsection{情報理論的安全性（閾値未満で情報が漏れない理由）}
\label{subsec:perfect_secrecy}
Shamir秘密分散の重要な性質は，閾値未満のシェア集合から秘密に関する情報が得られない点である．
直観的には，\(t<k\)個の点\((x_{i_1},y_{i_1}),\dots,(x_{i_t},y_{i_t})\)が与えられても，
それらを通る次数\(k-1\)以下の多項式は多数存在し，定数項（秘密）も任意に取り得るためである．

より具体的には，任意の候補秘密\(s'\in\mathbb{F}_p\)に対して，
「\(f(0)=s'\)かつ与えられた\(t\)点を満たす」次数\(k-1\)以下の多項式は少なくとも一つ存在し，
さらに自由度が\(k-1-t\)だけ残るため，その個数は同程度（\(\mathbb{F}_p\)上で一様）に分布する．
したがって，観測者が得る\(t(<k)\)個のシェアは秘密\(s\)の事後分布を変えず，
秘密に関する相互情報量は0となる（perfect secrecy）\cite{shamir1979}．
この性質により，本研究では「\(r<k\)では当該秘密は復元できない」という前提を
情報理論的に保証できる．

\section{pHashの計算手順}
\label{sec:phash_detail}
pHashは標準的手順に従い，次の手順で64bitのビット列$b$を得る：
\begin{enumerate}
  \renewcommand{\labelenumi}{(\roman{enumi})}
  \item 画像を$32\times32$のグレースケールに正規化する．
  \item DCTを適用する．
  \item 左上の低周波ブロック（$8\times8$相当）を取り出す．
  \item 係数の代表値（例：中央値）を閾値として2値化し，64bitのビット列$b$を得る．
\end{enumerate}
この低周波側の符号パターンを，以下「pHashの低周波符号」と呼ぶ．


\chapter{提案手法}
\label{chap:proposal}

\section{動機付け}
第2章で整理したように，プライバシー保護型CBIRの多くは，高次元特徴量（CNN埋め込み等）を暗号化・秘密分散し，
距離計算そのものを安全計算化することで「復元せずに検索する」ことを目指してきた．
一方で，本研究が扱うのは，そもそも原画像をサーバに置かず，画像自体を秘密画像共有（Secret Image Sharing; SIS）で分散保持する状況である．
この状況では，検索のたびに閾値以上のシェアを集めて復元し，原画像に対して特徴抽出・照合を行う運用が素朴な解になるが，
ボトルネックは次の3点である．
\begin{itemize}
  \item 復元に伴う計算・通信コストが追加で発生しやすい．
  \item 復元には閲覧権限（復元許可）が必要となる．
  \item 復元には所定数のシェア収集が前提となり，「検索のみ許可したい」という要求と整合しにくい．
\end{itemize}

他方で，復元を避けるために，pHash等の検索用表現を外部にそのまま露出させ，照合結果（距離や順位）を返す設計は，
サーバを信頼しない（semi-honest）環境では，照合可否オラクルに悪用され得る．
知覚ハッシュは暗号学的ハッシュのような一方向性を目的としておらず，「似ているものは近い値になる」よう設計されているため，
露出させ方を誤ると，オラクル自体が情報露出の手がかりになる．
したがって本研究では，「検索を成立させるために必要な情報」と「閲覧（内容推定）につながる情報」を同一視せず，
どの段階で何を開示するかを，閾値に基づいて明示的に分離する方針を採る．

本研究の要点は次の通りである．
第一に，SISの枠組みを保ったまま，シェア収集数に応じて出力の\emph{種類}を切り替える三段階開示モデルを導入する．
第二に，検索段階では，pHash検索に必要な情報だけを満たす検索専用出力（pHash整合ダミー）を生成し，
閲覧に資する視覚情報は意図的に劣化させる．
第三に，比較は64bit程度の軽量なpHashに限定し，検索処理を過度に重くしない設計を優先する．

\section{問題設定と記号}
\label{sec:notation}

本章では，提案手法を記述するために必要な問題設定，記号，および脅威モデルを定義する．
具体的には，入力画像$I$，pHash表現$b$，SISのパラメータ$(n,k)$と収集シェア数$r$を導入し，
semi-honestなサーバ（結託を含む）が観測可能な情報の範囲と，本研究が前提とする安全性条件を明確化する．
また，後続章で用いる段階的開示（Level 0/1/2）の定義を与える．

\subsection{問題設定（システムモデル）}
本研究では，画像の保持者（クライアント）が画像$I$を秘密分散し，
複数の保持者（サーバ群，あるいは分散保管ノード）にシェアを配布する状況を考える．
検索要求が発生した際，収集可能なシェア数$r$に応じて， 検索に必要な最小限の出力のみを返す（閲覧はさせない）
または，原画像$I$の復元を許可する，という出力制御を行う．

\subsection{記号}
入力画像を$I$とし，pHashを64bitのビット列$b\in\{0,1\}^{64}$で表す．
総シェア数を$n$，収集したシェア数を$r$とする．
段階的開示のために二つの閾値$k_1,k_2$（$k_1<k_2$）を設ける．

pHashは知覚ハッシュの一種であり，画像を正規化してDCTに基づく低周波成分を要約し，
得られた64bit列$b$をHamming距離で比較する（詳細な計算手順は\ref{sec:phash_detail}で述べる）．

\subsection{脅威モデル}
脅威モデルとしては，サーバ（および一部の保持者）はプロトコルには従うが，観測できる情報（保持データ，出力，ログ，アクセスパターン等）から推測を試みるsemi-honestを想定する．
また，複数主体が結託して観測情報を統合する可能性も考慮するが，閾値未満では復元できないことを前提とする．



\section{三段階開示モデル（Level 0/1/2）}
\label{sec:three_level_model}
本研究は，シェア収集数に応じて「何ができるか」を三段階に分離する．
総シェア数を$n$，収集したシェア数を$r$とし，二つの閾値$k_1,k_2$（$k_1<k_2$）を設ける．

\begin{itemize}
  \item \textbf{Level 0（$r<k_1$）}：
  通常のSISシェアのみが得られている段階であり，検索に資する情報を追加で開示しない．
  実装上は，外部に返す出力が必要な場合，秘密と独立なノイズ画像（プレースホルダ）を返す．

  \item \textbf{Level 1（$k_1\le r<k_2$）}：
  検索のみを許可する段階であり，pHash検索に必要な条件だけを満たす「検索専用出力」を生成して開示する．
  本研究ではこれをpHash整合ダミーと呼ぶ．

  \item \textbf{Level 2（$r\ge k_2$）}：
  復元（閲覧）を許可する段階であり，原画像$I$の復元を可能にする．
\end{itemize}

この三段階は，「画像を三回別々に分割する」という意味ではない．
同じ参加者に対して配布するシェアの中に，\emph{検索段階に必要な秘密}と\emph{復元段階に必要な秘密}を同居させ，
集まったシェア数に応じて復元できる対象を切り替える，という設計である．
開示規則は次式で表せる：
\[
  \mathrm{output}(r)=
  \begin{cases}
    \mathrm{noise} & (r<k_1)\\
    \mathrm{dummy}(b) & (k_1\le r<k_2)\\
    I & (r\ge k_2)
  \end{cases}
\]
ここで$\mathrm{dummy}(b)$は，pHashが$b$と一致することを満たす一方で，
視覚的内容が読み取りにくいように劣化させた画像である．
（Level 1は「pHash一致は満たすが，閲覧に十分な視覚情報は保証しない」ことを狙う段階である．）

\section{Shamir法の画像への適用（データ表現）}
\label{sec:shamir_image_application}

本研究では，前述のShamir秘密分散法（第\ref{sec:shamir_basics}節）を用いて画像を分散する．
この際，画素集合やバイト列である画像データを，有限体\(\mathbb{F}_p\)上の計算で扱える形式（整数）へ適切に符号化する必要がある．
本節では，本研究におけるデータ表現とShamir法の適用方法について述べる．

\subsection{有限体とパラメータの選択}
本研究では有限体として\(\mathbb{F}_p\)（\(p\)は十分大きな素数）を採用し，
具体的には
\begin{equation}
  p = 2^{521}-1
\end{equation}
を用いる（一般化メルセンヌ形であり，楕円曲線P-521の法としても用いられる）\cite{nist_sp800_186}．
これにより，画像をバイト列として扱い，\(p\)未満に収まるよう固定長チャンクへ分割して
各チャンクを整数（\(\mathbb{F}_p\)の元）として分散する運用が容易になる．

\subsection{画像の整数化とチャンク分割}
画像\(I\)をバイト列\(\mathrm{bytes}(I)\)として取り出し，
長さ\(L\)バイトのブロックに分割して，各ブロックをビッグエンディアンで整数化する：
\begin{equation}
  m_j := \mathrm{int}(\mathrm{bytes}_j)\in[0,256^{L}) \subset \mathbb{F}_p .
\end{equation}
\(256^{L}<p\)となるように\(L\)を選べばオーバーフローを避けられる．
復元後に元のバイト列へ戻せるよう，総バイト長や最終ブロックの有効長をメタ情報として保持する．

また，本研究で低閾値側の秘密として用いるpHashビット列\(b\in\{0,1\}^{64}\)については，
64bit整数にパックしてそのまま\(s\in\mathbb{F}_p\)として扱う．
以上の符号化を前提として，次節では「検索用秘密」と「復元用秘密」を別々にShamir分散し，
同一参加者に束ねて配布する二段閾値SISの構成を述べる．

\section{二段閾値SIS（検索用秘密と復元用秘密の同時分散）}
\label{sec:two_level_sis}
三段階開示を実現するための基本的な考え方は，各参加者に配るデータ（シェア）の中に，「検索用」と「完全復元用」という二つの独立したデータを埋め込んでおくことである．
直観的には，集まったシェアの数に応じて，取り出せるデータの種類（深さ）が変わる構造を作る．
具体的には，ある閾値$k_1$以上集まれば「検索用データ」だけが復元でき，これを用いて検索可能なノイズ画像（pHash整合ダミー）を生成する．
さらに多くの閾値$k_2$（$>k_1$）以上集まれば，「原画像データ」まで復元し，元の画像を取り戻せる．

これを形式化するため，本研究では二種類の秘密を定義する：
低閾値側の秘密を$s_L$，高閾値側の秘密を$s_H$とする．
\[
  s_L := b \in \{0,1\}^{64}, \qquad s_H := I
\]
ここで$s_L$は閾値$k_1$で復元可能，$s_H$は閾値$k_2$で復元可能となるように分散する．

具体的には，$s_L$を定数項とする次数$k_1-1$の多項式$f_L(x)$と，$s_H$を定数項とする次数$k_2-1$の多項式$f_H(x)$をそれぞれ独立に生成する（係数はランダムに選ぶ）．
各参加者$i$に対しては，それぞれの多項式の評価値を束ねて
\[
  \mathrm{share}_i = \bigl(i,\ f_L(x_i),\ f_H(x_i)\bigr)
\]
を配布する．
ここで$f_L(x_i)$は$s_L$のシェア，$f_H(x_i)$は$s_H$のシェアに相当する．
このとき，
$r<k_1$では$s_L,s_H$はいずれも復元できず，
$k_1\le r<k_2$では$s_L$のみ復元でき，
$r\ge k_2$で初めて$s_H$が復元できる．
すなわち「シェア数に応じて復元できる秘密が変わる」という意味で，多閾値（multi-threshold）／多層（multi-level）のアクセス構造として整理できる．

以降の実験では，具体例として$n{=}5$，$(k_1,k_2)=(2,4)$を用いる．
ただし本章の議論はこの値に依存しない．

\section{pHash整合ダミーの生成}
本節では，Level 1で開示するpHash整合ダミー$\mathrm{dummy}(b)$の生成法を述べる．
ここで重要なのは，Level 1では原画像$I$を復元しない点である．
したがって，ダミー生成は，Level 1で復元できる情報（本研究では$s_L=b$）から実行できなければならない．

直観的には，pHashが参照する低周波側の条件だけを満たすように周波数領域を構成し，
それ以外（特に高周波成分）はランダム化することで，pHash一致と視認性低下を両立させる．
具体的な手順は次の通りである：

\begin{enumerate}
  \item Level 1で復元したビット列$b$を入力として，$32\times32$画像に対するDCT係数行列のうち，
  低周波ブロック（$8\times8$相当）に対応する係数に対し，ビット$b_i=1$ならば正の値，
  $b_i=0$ならば負の値を割り当てることで，符号パターンが$b$と整合する
  目標係数$\widetilde{C}_{\mathrm{LF}}$を構成する．
  \item 逆DCT後の微小なゆらぎで符号が反転しないように，低周波係数に\emph{マージン}を持たせるため，
  係数の絶対値を一定量以上に設定する（本論文ではこれを「低周波係数の強調」と呼ぶ）．
  \item 高周波側の係数$\widetilde{C}_{\mathrm{HF}}$は乱数で埋める．
  これにより，輪郭・文字・顔など閲覧に資する細部構造が再現されにくいようにする．
  \item 構成した係数行列$\widetilde{C}$に逆DCT（IDCT）を適用して空間画像$\widetilde{I}$を得る．
  \item $\widetilde{I}$からpHashを再計算し，$b$と一致することを確認する．
  一致しない場合は低周波係数の強調量（マージン）を増やすなどして再生成する．
\end{enumerate}

\begin{figure}[t]
  \centering
  \includegraphics[width=\linewidth]{output/phash_masked_sis_eval/pipeline_top3.png}
  \caption{ダミー生成の途中出力例（pHash 符号$\rightarrow$低周波補強$\rightarrow 32\times 32$ 空間画像）}
  \label{fig:dummy-top3}
\end{figure}

このようにして得られる$\widetilde{I}$をpHash整合ダミー$\mathrm{dummy}(b)$として用いる．
ここで，pHash整合ダミーは「pHash一致」を満たすための検索専用出力であり，
視覚的内容の復元（閲覧可能性）を保証しない点が本質である．
以後の章では，ダミーの視認性低下をPSNR（Peak Signal-to-Noise Ratio）やSSIM（Structural Similarity）等の指標で評価し，
また検索段階（Level 1）での偽一致（衝突）についてはHamming距離の閾値判定とあわせて実験で確認する．

\section{安全性の扱い（Shamirの保証とダミーの評価）}
Shamir秘密分散は，閾値未満のシェア集合から秘密に関する情報を与えないという情報理論的安全性をもつ．
したがって本研究の構成では，
$r<k_1$で$s_L$（pHash）も$s_H$（原画像）も復元できないこと，
および$k_1\le r<k_2$で$s_H$が復元できないことは，
分散方式の性質として保証される．

一方で，Level 1では$s_L=b$を用いて検索を成立させるため，
低周波符号に関する情報露出が\emph{ゼロ}であることは保証しない．
本研究が主張するのは，(i) 閾値設計により「検索のために開示する情報」と「復元（閲覧）に必要な情報」を分離し，
(ii) Level 1の出力は検索に必要な条件（pHash一致）を満たしつつ，
閲覧に資する視覚情報を劣化させるよう構成される，という設計上の性質である．
そのうえで，「どの程度閲覧に耐えないか」「どの程度偽一致が起きないか」は，
PSNR/SSIMやpHash距離分布，Precision@kなどの実験指標により評価する（詳細は第4章）．

\section{検索パイプライン}
本研究の検索パイプラインは，検索処理を必要最小限に保つため，
比較はpHash（64bit）とHamming距離に限定する．
シェア生成・復元はクライアント側で完結させ，サーバは検索用データベース（pHashの索引等）を保持し照合を行うが，
サーバはsemi-honestであり得るという前提のもと，開示レベルに応じて入力として与えるものを切り替える．

具体的には，
$r<k_1$では検索自体を行わず（または秘密と独立なプレースホルダのみを扱い），
$k_1\le r<k_2$では復元した$b$からpHash整合ダミーを生成して検索入力とし，
$r\ge k_2$では原画像$I$を復元して必要に応じて平文側の処理へ移行する．
このように，閾値到達に応じて「検索専用の入力」と「復元入力」を切り替えることで，
検索と閲覧（復元）の権限・コストを段階的に分離する．


\chapter{実験}
\label{chap:conditions}
本章では，第3章で述べた三段階開示方式を，実験手順として具体化する．
あわせて，評価で用いる実装上の設定（パラメータ，乱数の扱い，指標の算出方法）も本章で明確化する．
本章の導入として，原画像・ノイズ（$r<k_1$）・pHash 整合ダミー（$k_1\le r<k_2$）・復元画像（$r\ge k_2$）の
代表例を図\ref{fig:exp-grid}に示す．

\begin{figure}[t]
  \centering
  \includegraphics[width=1.0\linewidth]{output/figures/phash_masked_sis/combined_pipeline.png}
  \caption{三段階出力の可視化例（複数画像の比較：原画像／ノイズ／pHash 整合ダミー／復元）}
  \label{fig:exp-grid}
\end{figure}

\section{実験条件・手順}

\subsection{評価指標}
本節では検索性能の評価指標として Precision@K と Recall@K を用いる．
ここで K は評価する上位件数である．
クエリ画像 $q$ に対して検索結果上位 $K$ 件を $\mathrm{Top}K(q)$，正解集合を $G(q)$ とすると，
\begin{align}
  \mathrm{Precision@}K(q) &= \frac{|\mathrm{Top}K(q)\cap G(q)|}{K}, \\
  \mathrm{Recall@}K(q) &= \frac{|\mathrm{Top}K(q)\cap G(q)|}{|G(q)|}
\end{align}
で定義する．
原画像のみを対象とする評価（以降「オリジナル評価」）では各クエリの正解は同一原画像 1 件とし（$|G(q)|=1$），
派生画像群を正解集合とする評価（以降「バリアント評価」）では同一元画像から生成された派生画像群を $G(q)$ とする．

\subsection{挙動確認と可視化指標}
前節の検索性能に加え，提案方式の基本挙動（安全性と品質のトレードオフ）を確認するための指標として以下を用いる．
まず，ダミーと原画像の視覚的乖離の程度を定量化するため PSNR（Peak Signal-to-Noise Ratio）を算出する（図\ref{fig:mask-mse}）．
さらに，ダミー生成の内部状態（低周波構成と補強の効果）を確認するため，
処理途中の $32\times 32$ 画像を出力する（図\ref{fig:dummy-top3}）．

\begin{figure}[t]
  \centering
  \includegraphics[width=\linewidth]{output/figures/phash_masked_sis/data00_tuned/stats_mse.png}
  \caption{PSNR の分布（ダミーと原画像）}
  \label{fig:mask-mse}
\end{figure}



\subsection{データと派生画像の生成}
COCO val2017 \cite{mscoco} から乱数シード 2025 により 500 枚をサンプリングし，これをクエリ集合とした．
また，各原画像から固定パラメータの画像変換を適用し，派生セットを作成した．
派生の種類は original を含めて 20 種とし，対応関係を \texttt{mapping.json} に記録した．
具体的には JPEG（q75, q60, q50+サブサンプリング），WebP（q70），回転$\pm30^\circ$（黒埋め），
30\% クロップ，台形射影，リサンプリング（双線形$\rightarrow$最近傍），ガンマ 0.7/1.3，
明るさ -25，コントラスト +30，ガウシアンノイズ $\sigma=10/15$，ソルト\&ペッパー 5\%，
モーションブラー，透かしロゴ，矩形遮蔽を用いた．

\subsection{検索・比較の手順}
各画像について次の処理を行った．
\begin{enumerate}
  \item 32$\times$32 グレースケール化と pHash 計算（64bit）．
  \item pHash 符号を保ったまま高周波成分をノイズ化した pHash 整合ダミーの生成（$k_1$ 到達時の検索用出力）．
  \item 原画像（平文）とダミーを $n=5,(k_1,k_2)=(2,4)$ の二階層 Shamir によりシェア化し，
  $r<k_1$ では復元不能（ノイズ相当），$k_1\le r<k_2$ ではダミーのみ出力可能，$r\ge k_2$ で原画像を復元可能とした．
\end{enumerate}

検索性能の比較は，原画像の pHash による検索（plain）と，
$k_1$ 到達時に得られるダミー画像の pHash による検索（dummy\_k1）の 2 条件で行った．
探索では 64bit を 8 分割（bands=8）したバケット化により候補集合を絞り込み，
候補に対して Hamming 距離を計算して順位付けを行った．
さらに閾値 $\tau=8$ を用い，距離が閾値以下の候補をヒットとして扱う設定とした．
本設定により，各クエリについて上位 $K\in\{1,5,10\}$ の Precision@K/Recall@K と処理時間を集計した．

\section{結果・考察}
本節では，(i) 検索精度（Precision@K/Recall@K），(ii) 処理時間を
plain と dummy\_k1 で比較し，$k_1$ 到達時の検索段階で平文と同等の挙動を維持できるかを確認する．

\subsection{検索精度と時間（オリジナル評価）}
図\ref{fig:search-original-prec} と図\ref{fig:search-original-time} に，
オリジナル評価（各クエリの正解が 1 件）に対する結果を示す．
本条件では，正解が上位 1 件に入れば Precision@1=100\% となり，
上位 5 件に入れば Precision@5=20\%（$=1/5$），上位 10 件に入れば Precision@10=10\%（$=1/10$）となるため，
Precision@5 や Precision@10 は評価設定（$|G(q)|=1$）に依存して値が定まる点に注意が必要である．
実験では plain/dummy\_k1 ともに Precision@1=100\% であり，Recall@10 も 100\% であった．
処理時間は 0.581 ms/query（plain）と 0.548 ms/query（dummy\_k1）であり，
同一の比較 API（pHash 計算と Hamming 距離比較）で処理できるため差は小さい．

\subsection{バリアント評価（全 20 バリアント）}
次に，全 20 バリアント条件では正解集合を「同一元画像から生成された派生画像群」とし，
によりバリアントごとの精度と時間を集計した．
全バリアント平均として Precision@1=100\%，Precision@5=86.6\%，Precision@10=84.82\%，
Recall@10=42.41\% が得られ，これらの値は plain と dummy\_k1 で一致した（図\ref{fig:search-all-prec}）．
これは，dummy\_k1 が pHash 計算に影響する低周波側の条件を一致させる設計であり，
比較が pHash（Hamming 距離）のみで完結するため，候補生成と順位付けが一致し得ることを反映している．
処理時間も 0.527 ms/query（plain）と 0.494 ms/query（dummy\_k1）で差が小さく（図\ref{fig:search-all-time}），
$k_1$ 到達時の検索段階で計算負担を増やさずに適用できることを示している．

\subsection{検索の実用性}
本実装条件では，「検索段階（$k_1$ 到達）において，平文検索と同等のランキング結果・同等の処理時間を維持できる」ことを確認した．
これは，「復元（閲覧）を許可せずに検索のみ行う」運用要求に対して，
復元ベースの検索手順を回避しつつ検索の実用性（精度と時間）を確保できる可能性を示す．

\subsection{安全性評価の範囲と課題}
一方で，本章の比較は pHash 検索（距離分布とランキング一致）に限定されており，
Level 1 で開示される情報（pHash 符号や照合結果）が，オラクルとしてどの程度推測に利用され得るかを直接評価するものではない．
本研究の保証範囲は，Shamir の閾値性（$r<k_2$ で原画像が復元不能）に基づく部分と，
Level 1 の出力が視覚的内容推定に結びつきにくいという経験的評価に分かれる．
したがって今後は，攻撃者モデルを明示したうえで，
問い合わせ回数制限・監査ログ・探索戦略の評価などを含む追加検証が必要である．

% 以降，図表はそのまま用いる
\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_figs/precision_summary.png}
  \caption{Precision（平均値，オリジナル評価；各クエリの正解は1件）}
  \label{fig:search-original-prec}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_figs/time_summary.png}
  \caption{Latency（平均値，オリジナル評価）}
  \label{fig:search-original-time}
\end{figure}

\begin{table}[t]
  \centering
  \caption{評価した20バリアントの例（mapping.json）}
  \small
  \begin{tabular}{>{\raggedright\arraybackslash}p{3.9cm} >{\raggedright\arraybackslash}p{3.9cm}}
    \hline
    フォトメトリック系 & 幾何・ノイズ系 \\
    \hline
    brightness\_minus25 & rotate\_plus30\_black \\
    contrast\_plus30 & rotate\_minus30\_black \\
    gamma\_0\_7, gamma\_1\_3 & crop\_balanced\_30 \\
    jpeg60, jpeg75, jpeg\_q50\_subs & perspective\_trapezoid \\
    webp\_q70 & resample\_bilinear\_nearest \\
    watermark\_logo & gaussian\_sigma10,15 \\
    & salt\_pepper\_5, motion\_blur \\
    & occlusion\_rectangle \\
    \hline
  \end{tabular}
\end{table}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_all_figs/precision_summary_all_variants.png}
  \caption{Precision@1（バリアント別，plain vs dummy\_k1）}
  \label{fig:search-all-prec}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_all_figs/time_summary_all_variants.png}
  \caption{Latency（バリアント別，plain vs dummy\_k1）}
  \label{fig:search-all-time}
\end{figure}


\chapter{おわりに}
本研究は，検索可能なSISフレームワークのための知覚暗号化を設計した．
本研究の成果は以下のように整理できる．

\begin{itemize}
  \item 検索可能性と閲覧可能性を混同せずに制御するための段階開示モデルを提示した．
  \item 具体的には，シェア収集数$r$に応じて開示レベルを切り替える枠組みを定義し，$r < k_1$ では検索に資する情報を開示せず（Level 0），$k_1 \le r < k_2$ では検索のみを許可する出力（Level 1）を開示し，$r \ge k_2$ で初めて復元（Level 2）を許可するという二つの閾値$k_1, k_2$に基づくアクセス構造として定式化した．
  \item これにより，「検索だけ許可したい」という運用要求を，復元許可（閲覧許可）と切り離して扱えることを明確化した．
\end{itemize}
実験では，pHash 整合ダミーにより平文 pHash と同等のランキング結果と処理時間を維持でき，
また検索（$k_1$）と復元（$k_2$）で処理負担が段階化されることを確認した．

一方で，Level 1 では検索を成立させるために pHash の情報を開示しているため，これが安全性への懸念点として残る．
具体的には，前述したオラクルとして機能することで元の画像情報を推測されるリスクや，どの画像を検索したかという履歴（アクセスパターン）からの情報漏えいである．
今後は，こうした漏えいを防ぐためのアクセスパターン秘匿技術の導入や，
ダミー画像から具体的にどの程度元の内容が推測できてしまうかのより詳細な評価（人手による判定や属性推定など）が必要である．
また，pHash よりも頑健な特徴量の採用や，大規模なデータベースでの実用性検証も進めていく必要がある．

\begin{thebibliography}{99}
  \bibitem{muller2020mir}
H.~M{\"u}ller,
``Medical Image Retrieval: Applications and Resources,''
in \emph{Proceedings of the ACM International Conference on Multimedia Retrieval (ICMR 2020)},
2020.
doi:10.1145/3372278.3390668.

\bibitem{sotomayor2021cbmir}
C.~G.~Sotomayor, M.~Mendoza, V.~Casta{\~n}eda, H.~Far{\'i}as, and others,
``Content-Based Medical Image Retrieval and Intelligent Interactive Visual Browser for Medical Education, Research and Care,''
\emph{Diagnostics}, vol.~11, no.~8, 1470, 2021.
doi:10.3390/diagnostics11081470.

\bibitem{su2007decision_support}
M.-J.~Su, H.-S.~Chen, C.-Y.~Yang, S.-J.~Chen, R.~Chen, W.-J.~Lee, P.-H.~Cheng, 
P.-K.~Yip, H.-M.~Liu, F.-P.~Lai, and D.~Racoceanu,
``Diagnostic Decision Support by Intelligent Medical Image Retrieval with Electronic Medical Record for Dementia Treatment Enhancement,''
\emph{Medical Imaging Technology}, vol.~25, no.~5, pp.~350--359, 2007.
doi:10.11409/mit.25.350.

\bibitem{xu2017ppcbir_cloud}
Y.~Xu, J.~Gong, L.~Xiong, Z.~Xu, J.~Wang, and Y.-Q.~Shi,
``A Privacy-Preserving Content-Based Image Retrieval Method in Cloud Environment,''
\emph{Journal of Visual Communication and Image Representation}, vol.~43, pp.~164--172, 2017.
doi:10.1016/j.jvcir.2017.01.006.

\bibitem{ferreira_iescbir}
D.~Ferreira, R.~Rodrigues, P.~Leit{\~a}o, and D.~Domingos,
``Privacy-Preserving Content-Based Image Retrieval in the Cloud,''
in \emph{Proceedings of the 34th IEEE Symposium on Reliable Distributed Systems (SRDS 2015)},
pp.~11--20, 2015.
doi:10.1109/SRDS.2015.27.

\bibitem{semi_honest_katz}
J.~Katz and Y.~Lindell,
\emph{Introduction to Modern Cryptography},
3rd ed., Chapman and Hall/CRC, 2020.
doi:10.1201/9781351133036.

\bibitem{farid2021phash}
H.~Farid,
``An Overview of Perceptual Hashing,''
\emph{Journal of Online Trust and Safety}, vol.~1, no.~1, 2021.
doi:10.54501/jots.v1i1.24.

\bibitem{jain2022usenix_phash}
S.~Jain, A.-M.~Cre{\c t}u, and Y.-A.~de Montjoye,
``Adversarial Detection Avoidance Attacks: Evaluating the Robustness of Perceptual Hashing-Based Client-Side Scanning,''
in \emph{31st USENIX Security Symposium (USENIX Security 22)}, Boston, MA, 2022, pp.~2317--2334.

\bibitem{pha_robustness_2024}
J.~Prokos, N.~Fendley, M.~Green, R.~Schuster, E.~Tromer, T.~Jois, and Y.~Cao,
``Squint Hard Enough: Attacking Perceptual Hashing with Adversarial Machine Learning,''
in \emph{32nd USENIX Security Symposium (USENIX Security 23)}, Anaheim, CA, 2023, pp.~211--228.



\bibitem{tassa2007hierarchical}
T.~Tassa,
``Hierarchical Threshold Secret Sharing,''
\emph{Journal of Cryptology}, vol.~20, no.~2, pp.~237--264, 2007.
doi:10.1007/s00145-006-0334-8.

\bibitem{benaloh1988gss}
J.~C.~Benaloh and J.~Leichter,
``Generalized Secret Sharing and Monotone Functions,''
in \emph{Advances in Cryptology---CRYPTO '88}, LNCS 403, pp.~27--35, Springer, 1990.
doi:10.1007/0-387-34799-2\_3.

\bibitem{naor1994visualcrypto}
M.~Naor and A.~Shamir,
``Visual Cryptography,''
in \emph{Advances in Cryptology---EUROCRYPT '94}, LNCS 950, pp.~1--12, Springer, 1994.
doi:10.1007/BFb0053419.

\bibitem{jin2005progressive_color}
D.~Jin, W.~Q.~Yan, and M.~S.~Kankanhalli,
``Progressive Color Visual Cryptography,''
\emph{Journal of Electronic Imaging}, vol.~14, no.~3, 033019, 2005.
doi:10.1117/1.1993625.

\bibitem{xiong2021cppsis}
L.~Xiong, Z.~Han, and M.~Yang,
``CP-PSIS: CRT and polynomial-based progressive secret image sharing scheme,''
\emph{Signal Processing}, vol.~185, 108064, 2021.
doi:10.1016/j.sigpro.2021.108064.

\bibitem{liu2015visualcrypto_book}
F.~Liu and W.~Q.~Yan,
\emph{Visual Cryptography for Image Processing and Security: Theory, Methods, and Applications}, vol.~1,
Springer, 2015.
doi:10.1007/978-3-319-23473-1.

\bibitem{nist_sp800_186}
L.~Chen, D.~Moody, A.~Regenscheid, A.~Robinson, and K.~Randall,
``Recommendations for Discrete Logarithm-based Cryptography: Elliptic Curve Domain Parameters,''
NIST Special Publication 800-186, 2023.
doi:10.6028/NIST.SP.800-186.

\bibitem{Xia2020}
H.~Wang, Z.~Xia, J.~Fei, and F.~Xiao,
``An AES-Based Secure Image Retrieval Scheme Using Random Mapping and BOW in Cloud Computing,''
\emph{IEEE Access}, vol.~8, pp.~61138--61147, 2020.
doi:10.1109/ACCESS.2020.2983194.

\bibitem{Barni2010}
L.~Weng, L.~Amsaleg, A.~Morton, S.~Marchand-Maillet, and M.~Barni,
``A Privacy-Preserving Framework for Large-Scale Content-Based Information Retrieval,''
\emph{IEEE Transactions on Information Forensics and Security}, vol.~10, no.~1, pp.~152--167, 2015.
doi:10.1109/TIFS.2014.2365998.

\bibitem{Tian2024}
M.~Tian, Y.~Zhang, Y.~Zhang, X.~Xiao, and W.~Wen,
``A privacy-preserving image retrieval scheme with access control based on searchable encryption in media cloud,''
\emph{Cybersecurity}, vol.~7, Art.~22, 2024.
doi:10.1186/s42400-024-00213-z.

\bibitem{Venkatesan2000}
R.~Venkatesan, S.-M.~Koon, M.~Jakubowski, and P.~Moulin,
``Robust image hashing,''
in \emph{Proc. IEEE ICIP}, 2000.
\bibitem{shamir1979}
A.~Shamir,
``How to share a secret,''
\emph{Communications of the ACM}, vol.~22, no.~11, pp.~612--613, 1979.
doi:10.1145/359168.359176.

\bibitem{mscoco}
T.-Y.~Lin, M.~Maire, S.~Belongie, J.~Hays, P.~Perona, D.~Ramanan, P.~Doll{\'a}r, and C.~L.~Zitnick,
``Microsoft COCO: Common Objects in Context,''
in \emph{Computer Vision -- ECCV 2014}, Springer, 2014, pp.~740--755.
doi:10.1007/978-3-319-10602-1\_48.

\end{thebibliography}

\end{document}
