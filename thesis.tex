\documentclass[a4paper,10pt,report]{jsbook}

\usepackage[utf8]{inputenc}
%\usepackage[T1]{fontenc}
%\usepackage{newpxmath, newpxtext}
\usepackage{amsmath,amssymb}
\usepackage[bold]{otf}
\usepackage{titlesec}
\usepackage{cite}
\usepackage{colortbl}
\usepackage[dvipdfmx]{graphicx}
\usepackage{mathtools}
\usepackage{array}
\DeclarePairedDelimiter{\norm}{\lVert}{\rVert}
\newcommand{\sgn}{\text{sgn}}
\newcommand{\abs}{\text{abs}}
\newcommand{\refsiz}{\fontsize{6pt}{0cm}\selectfont}%for determining

\usepackage[dvipdfmx,top=25truemm,bottom=30truemm,left=30truemm,right=30truemm]{geometry}
\graphicspath{{./output/figures/coco_val2017_modular/}{./output/figures/phash_masked_sis/}{./output/phash_masked_sis_eval/}{./output/phash_masked_sis_eval/figures/}{./output/results/}}

\title{秘密画像共有におけるpHashでのシェア収集を可能にする\\
知覚暗号化の設計}

\newcommand{\thesistype}{2025年度 卒業論文}
\newcommand{\studentname}{玉城洵弥}
\newcommand{\studentid}{1213033903}
\newcommand{\advisor}{清水 恒輔}
\newcommand{\faculty}{工学部電気電子・情報工学科情報コース}
\newcommand{\university}{岐阜大学}

\author{氏名：\studentname\\学生番号：\studentid\\指導教員：\advisor}
\date{2026年2月6日}

\newcommand{\titlesize}{\fontsize{16pt}{20pt}\selectfont}

\makeatletter
\renewcommand{\maketitle}{
\thispagestyle{empty}
\begin{center}
\phantom{}
\vskip 36pt
{\titlesize \thesistype \par}
\vskip 36pt
{\titlesize\@title\par}
\vskip 266pt
{\titlesize\@author\par}
\vskip 36pt
{\titlesize{\faculty}\par}
\vskip 36pt
{\titlesize{\university}\par}
\vskip 24pt
{\fontsize{14pt}{18pt}\selectfont\@date\par}
\end{center}
\newpage
}
%TOCも含めて，欧文フォントをRomanに変更
\let\originall@chapter\l@chapter
\def\l@chapter#1#2{\originall@chapter{{\bfseries\rmfamily #1}}{\bfseries\rmfamily#2}}
\makeatother

\titleformat{\chapter}[display]{\normalfont\huge\bfseries}{\chaptertitlename\ \thechapter\ 章}{20pt}{\Huge}
\titleformat{\section}{\normalfont\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\normalfont\bfseries}{\thesubsubsection}{1em}{}

\renewcommand{\baselinestretch}{1.3}%行間
\begin{document}
\maketitle
\tableofcontents
\listoffigures
\listoftables

\chapter*{概要}
平文の画像特徴量をサーバに保持する従来の類似画像検索（Content-Based Image Retrieval; CBIR）には，
運用者・侵入者・ログ等を経由して画像内容や画像間の類似関係が漏えいし得るため，機微画像を扱う場面ではリスクがある．
そこで本研究では，プライバシー保護のために画像を秘密画像共有（Secret Image Sharing; SIS）で分散保持したうえで，
原画像を復元（平文化）せずに類似画像検索を実現したい状況を想定する．
本研究は，サーバを信頼しない（semi-honest：プロトコルには従うが得られる情報から推測を試みる）脅威モデルを想定する．
例えば，医療・監視・個人写真などの機微画像を複数主体（複数サーバ／複数保持者）に分散保管しつつ，
必要時に類似画像の検索だけを許可したいといったユースケースである．
このときシェアは暗号化画像のようにランダムに見えるため，平文画像に対するCBIRをそのまま適用できない．

しかし，類似検索には比較に用いる情報の露出が不可欠であり，復元／非復元の二択では運用上不十分である．
そこで本研究では「検索のみ許可／閲覧は禁止」という中間状態を設け，収集したシェア数に応じて権限を段階的に切り替える方式を提案する．

シェアのまま高速に類似性判定を行うために，知覚ハッシュの一種であるpHashを用いる．
pHashは画像を低次元のビット列に写像し，Hamming距離（XORとビットカウント）で高速比較できるため，
大規模データベースに対しても検索コストと保存コストを小さくできる．
一方で，SISのシェアは暗号化画像のようにランダムに見えるため，シェア画像そのものにpHashを適用しても元画像の類似性は保持されない．
そこで本研究では，pHashが主に低周波構造に依存する点に着目し，
閲覧に資する高周波成分は劣化させつつpHashに必要な低周波符号を一致させることで，
pHashの検索精度を落とさずにSIS上で検索を可能にする知覚暗号化方式を設計する．
具体的には，本研究はSISにおける多層（multi-level）／多閾値（multi-threshold）アクセス構造に基づき，
収集したシェア数$r$に応じて開示する情報（出力）を段階的に切り替える．
多閾値SISでは，複数の閾値をもつアクセス構造をあらかじめ定義し，満たされた閾値に応じて復元可能性や得られる情報を制御する\cite{guo2012multithreshold,wu2020hierarchical}．
本研究ではその最小構成として2段の閾値を設定し，$r$が第1閾値$k_1$に達すると検索のみを許可し，
$r$が第2閾値$k_2$に達すると原画像の復元を許可する（$k_1<k_2$）．
なお，これはシェア数の増加に伴い復元画像が徐々に鮮明化するprogressive VSSの「画質が連続的に向上する」設計とは異なり，
本研究では「検索専用の出力」と「復元可能な出力」を閾値で離散的に分離する点に特徴がある\cite{mehrnahad2023progressive}．

$k_1$到達時には，検索に必要な低周波符号が平文pHashと一致するように合成したダミー画像（pHash整合ダミー）を返す．
このダミーは，高周波成分をノイズ化して輪郭・文字・顔などの可読性を低下させ，内容推定に資する手掛かりを弱める一方で，
検索に必要な低周波符号は保持する．
また，異画像との衝突（偽一致）を抑えるため，Hamming距離の閾値判定も併用し，偽一致については評価により確認する（詳細は実験章）．

COCO派生データ（最大500クエリ）で評価した結果，元画像ではPrecision@1=100\%となり，平文pHashと同等の検索結果を維持した．
また，回転・切り抜き等の20種類の変換画像を含む条件でもPrecision@1=100\%，Precision@5=86.6\%，Precision@10=84.82\%であり，平文との差は小さかった．
処理時間も約0.5ms/件と平文と同等であり，復元時間は$k_1$到達時に121ms，$k_2$到達時に10.2sとなり，段階化できた．

\chapter{はじめに}

\section{背景}
医療画像や監視映像，個人写真などの機微画像では，画像内容を開示せずに類似事例を検索し，
診断・治療方針の検討や臨床教育，研究用途に活用したいという要求がある．
実際，医療分野ではContent-Based Medical Image Retrieval（CBMIR/CBIR）が，
症例参照型の意思決定支援や教育支援のための基盤技術として位置づけられてきた\cite{muller2020mir,sotomayor2021cbmir,su2007decision_support}．
しかし，これらの画像は患者情報や個人情報と強く結びつくことが多く，
「検索できる」こと自体が情報露出の入口になるため，利便性とプライバシーの両立が課題となる．

従来のコンテンツベース画像検索（Content-Based Image Retrieval; CBIR）は，
検索精度と運用容易性を優先し，画像特徴量（埋め込みやハッシュ等）をサーバ側で保持・照合する構成が一般的である．
ところがサーバを信頼しない（semi-honest / honest-but-curious）状況では，
サーバが保持する特徴量，照合の中間結果，アクセスパターンやログ等が攻撃面となり得る．
特徴量が漏えいした場合，画像内容・属性の推測（機微カテゴリの推定）や，
検索結果（近傍関係・ヒットの有無）を介したメタデータ漏えいが生じ得るため，
honest-but-curiousなクラウド（CSP）を想定したプライバシー保護CBIRが研究されてきた\cite{xu2017ppcbir_cloud,ferreira_iescbir}．

本研究では，さらに踏み込んで「サーバに平文画像を置かない」だけでなく，
画像そのものを秘密画像共有（Secret Image Sharing; SIS）により分散保持した画像集合を検索対象とする状況を扱う．
SISは画像を$n$個のシェアへ分割し，所定数（閾値）以上のシェアが揃った場合にのみ復元でき，
閾値未満では原画像に関する意味情報が得られないよう設計される（閾値型SIS）．
脅威モデルとしては，サーバ（および一部の保持者）はプロトコルには従うが，
保持データや観測可能な計算結果から推測を試みるsemi-honestを想定し\cite{semi_honest_katz}，
複数主体が結託して観測情報を統合する可能性も考慮する．
このとき，閾値未満のシェア集合からは原画像を復元できないことを安全性の前提とする．

しかし，ここで新たな問題が生じる．一般的なSISでは各シェアが単独では意味情報を与えないよう生成されるため，
平文画像を前提とするCBIR（特徴抽出・比較）をシェアに直接適用しても，
原画像間の類似関係を反映した比較結果は得られない．
したがって素朴には，検索の都度，(i) 閾値以上のシェアを収集して復元（平文化）し，
その後に特徴抽出・類似度計算を行う手順が必要となる．
ところがこの復元ベース手順は，計算・通信の追加コストを伴うだけでなく，
復元許可（閲覧権限）と閾値を満たすシェア収集を前提とするため運用上の制約が大きい．
すなわち，「閲覧は許可しないが検索のみ行いたい」という要求を，
復元を前提とする設計だけで満たすことは難しい．
このため，秘密分散による保護状態を維持したまま，
検索に必要な情報のみを制御して利用可能とする検索方式が必要となる．

本研究では，検索の特徴量として知覚ハッシュ（perceptual hash; pHash）を採用する．
pHashは画像を小サイズに正規化した後にDCTを適用し，
低周波成分から64bitの指紋を生成することで，
軽量なビット列比較（Hamming距離：XORとビットカウント）で高速に近似類似検索を行える\cite{phash_hackerfactor}．
このような（低次元・ビット演算中心の）比較は，大規模データベースに対しても計算資源と保存容量を抑えやすく，
本研究が想定する「サーバを信頼しない」環境下での実装・運用上の利点が大きい．
一方で，知覚ハッシュは照合結果がブラックボックス・オラクルとして悪用され得ることや，
実運用のPHAs（PhotoDNA/PDQ/NeuralHash等）に対する攻撃評価も報告されている\cite{jain2022usenix_phash,pha_robustness_2024}．
したがって，検索機能を提供する場合でも，どの情報をどの段階で開示するかは慎重に設計しなければならない．

以上より，本研究の課題は，
SISにより保護された画像集合に対し，(1) 秘密分散による保護状態を維持しつつ，
(2) 検索に必要な情報のみを段階的に制御して開示し，
(3) pHashに基づく高速な類似検索を成立させる方式を設計することである．

\section{目的}
復元を伴わない検索を実現するために，pHash等の検索用表現を外部にそのまま露出させる設計は，
照合可否や距離情報が探索・推測の手掛かり（オラクル）となり得る点で望ましくない．
知覚ハッシュは暗号学的ハッシュのような一方向性を前提とせず，類似性を保存する指紋として設計されているため，
検索機能そのものが情報露出の窓口になり得る\cite{phash_hackerfactor}．

そこで本研究は，検索可能性と閲覧可能性を段階的に制御するため，開示レベルを三段階に分離する方式を確立することを目的とする．
総シェア数を$n$，収集したシェア数を$r$とし，二つの閾値$k_1,k_2$（$k_1<k_2$）を設ける．
$r<k_1$では，通常のSISシェア以外の検索用情報は開示しない（Level 0）．
$k_1\le r<k_2$では検索のみを許可し，pHash検索に必要な情報だけを含む検索専用出力を開示する（Level 1）．
$r\ge k_2$で初めて原画像の復元を許可する（Level 2）．

Level 1では，pHash計算で参照される低周波成分に対応する符号が平文pHashと一致するように合成したダミー画像
（pHash整合ダミー）を出力する．
一方で，輪郭・文字・顔など内容推定に資する視覚情報は高周波成分のマスク／ノイズ化により意図的に劣化させ，
閲覧可能性を抑制する．
すなわち，pHash整合ダミーは「検索のための一致（pHashの一致）」を満たすが，
「視覚的内容の復元（閲覧）」は保証しない出力である．

このように，閾値に応じて開示する情報の種類を切り替える点は，多層（multi-level）／多閾値（multi-threshold）アクセス構造に基づく段階開示として位置づけられる\cite{guo2012multithreshold}．
これに対し，シェア数の増加に伴い復元画像の画質が段階的に向上すること自体を主眼とするprogressive型（PVC/Progressive VSS）とは狙いが異なり\cite{progressive_vc_acm,progressive_vc_springer}，
本研究は「検索専用の出力」と「復元可能な出力」を閾値で離散的に分離し，検索可能性と閲覧可能性を分けて制御する点に特徴がある．


\section{貢献}
本研究の貢献は次の三点である．
第一に，SIS上での類似画像検索に対して，三段階（Level 0/1/2）の開示レベルと二つの閾値（$k_1,k_2$）を定義し，
検索に必要な情報と閲覧（内容推定）に資する情報を分離して制御する段階開示モデルを提示した．
第二に，Level 1の検索専用出力としてpHash整合ダミーを設計し，
既存のpHash検索（64bit指紋とHamming距離比較）と同一の入出力で扱える形で，
$r$に応じて（非開示／検索／復元）を切り替える処理パイプラインを実装した．
第三に，COCO派生データを用いて，平文画像とpHash整合ダミーの検索結果（Precision@k）および処理時間を比較し，
検索精度の維持と段階開示の有効性を実験的に示した．

\chapter{関連研究}
本研究は，SIS 上で pHash 検索を可能にする知覚暗号化方式の設計を目的とする．近年，プライバシー保護を目的とした類似画像検索（Content-Based Image Retrieval; CBIR）の研究は，暗号技術，秘密分散，多人数安全計算（Multi-Party Computation; MPC），検索可能暗号（Searchable Encryption; SE）など，多様な手法を基盤として発展してきた．本章では，(1) 類似画像検索の特徴量，（2）秘密分散・MPC によるプライバシー保護 CBIR，（3）検索可能暗号による CBIR，（4）知覚ハッシュ（pHash）に関する研究，の4つの観点から既存研究を整理する．

\section{類似画像検索に用いられる特徴量：CNN と pHash}
従来の高精度 CBIR では，VGG, ResNet, EfficientNet などの CNN による高次元特徴量（512～4096次元）が一般的に利用されている．しかしこれらは特徴量の次元数が大きく，暗号化や秘密分散を用いたプライバシー保護処理において計算負荷が高くなることが報告されている（Xia et al.\cite{Xia2020}）．一方，pHash（Perceptual Hash）は，低周波領域 DCT の符号パターンから 64bit 程度のハッシュを算出する軽量な知覚特徴量であり，画像の大まかな構造に対してロバストである．しかし，pHash を暗号技術と統合し，プライバシーを保ったまま類似検索を可能にする枠組みは限定的であり，軽量性を活かした実用的な設計は十分に整理されていない．

\section{秘密分散・MPC を用いたプライバシー保護類似画像検索}
秘密分散や MPC を用いたプライバシー保護 CBIR の研究は活発に行われている．Xia et al.\cite{Xia2020} は，CNN 特徴量を加法的秘密分散により複数サーバへ分割し，サーバ間の MPC によって距離計算を実行する枠組みを提案した．検索処理は暗号化状態で行えるが，高次元特徴量を対象とするため処理が重い．また，Zhang et al.\cite{Zhang2024} は Shamir 型秘密分散を用いて CNN 特徴量を分散保持し，復元せずに検索する SS-CNN を提案したが，やはり高次元前提で段階的な情報開示は存在しない．画像特徴そのものを暗号化状態で計算する研究として，Barni et al.\cite{Barni2010} は JPEG DCT 係数を暗号化し距離計算を行い，Troncoso-Pastoriza et al.\cite{Troncoso2017} は近似距離 MPC を提供したが，いずれも準同型暗号や高度な MPC を要し計算コストが高い．さらに，これらの手法は平文特徴や高次元ベクトルを前提としており，知覚暗号化された低次元特徴（本研究の pHash 整合ダミーや SIS シェア）にそのまま適用すると精度が低下するか，復号を伴うため本研究の要件（検索のみ許可・閲覧禁止）に適合しない．加えて，上記いずれの研究も (1) シェア数に応じて復元内容が段階的に変化する設計，(2) pHash の符号構造を用いたダミー画像生成，を備えていない．

\section{検索可能暗号（SE）によるプライバシー保護 CBIR}
検索可能暗号を画像検索に応用した研究も存在する．Tian et al.\cite{Tian2024} は特徴量を暗号化し，ツリー構造インデックスに対して検索を行う SE ベースの CBIR を提案している．また，Xia et al.\cite{Xia2021} は暗号化画像に対して近似検索を行う方式を示した．ただし，既存の SE ベース CBIR は暗号処理が重く，pHash の軽量性や段階開示（$k_1/k_2$）を前提としていないため，本研究の要件（検索のみ許可／閲覧抑止）には適合しない．

\section{知覚ハッシュ（pHash）に関する研究}
知覚ハッシュは，画像同士の類似性を測るために広く利用されている．代表的手法として Venkatesan et al.\cite{Venkatesan2000} によるロバストハッシュ生成法が知られており，後続研究でも pHash は著作権管理や偽造検知に利用されてきた．しかし，pHash は本来 認証や重複検出が目的であり，プライバシー保護と結合する研究は著者の調査範囲では限定的である．特に「pHash 符号を保ったまま視覚情報を失わせる変換」や「段階開示／秘密分散と pHash 検索の統合」については，著者の調査範囲では体系的整理が少ない．

\chapter{提案手法}
\section{動機付け}
第2章の関連研究を踏まえると，本研究は以下の点に特徴がある。(1) pHash の低周波符号構造のみに基づき、視覚情報を欠く pHash 整合ダミー画像を生成できる点。(2) 秘密分散（SIS）を用い、シェア数に応じて「ノイズ」「pHash 整合ダミー」「原画像」という三段階の開示を実現した点。(3) 検索は軽量な pHash のみで実行し、プライバシーは段階的な復元制御によって保証する枠組みを確立した点。著者の調査範囲では，「pHash × 秘密分散 × 段階開示」を組み合わせた類似画像検索方式は限定的であり，軽量知覚特徴と暗号技術を統合する方向性に本研究の特徴がある．
さらに，既存研究との対比で強調すべき点は次の2つである．(a) 既存研究は高次元特徴を保ちながら距離計算を安全計算化する重い路線であり，段階開示を前提としていない．(b) 本研究は pHash に制約し，$k_1$ で検索のみ，$k_2$ で原本復元という役割分担で計算量を段階化する．

\section{記号と定義}
入力画像をグレースケール 32$\times$32 に縮小し DCT を取る。低周波 8$\times$8 ブロック $C_{\text{LF}}$ の符号で 64bit の pHash $b \in \{0,1\}^{64}$ を定義し、$b_i = 1$ は正、0 は負の符号を表す。二階層 Shamir は，同じインデックスで低閾値用の秘密と高閾値用の秘密をそれぞれ Shamir 分散し，$k_1$ でダミー，$k_2$ で原画像を復元する多段しきい値構成である。
本研究では秘密を2種類に分ける。低閾値側の秘密を $s_L := b$（pHash の 64bit 符号）、高閾値側の秘密を $s_H := I$（原画像データ）とする。各シェア番号 $i$ について、$s_L$ を閾値 $k_1$ の Shamir 秘密分散で、$s_H$ を閾値 $k_2$ の Shamir 秘密分散で、それぞれ同一の有限体 $\mathbb{F}_p$ 上で分散し、配布するシェアを $\mathrm{share}_i=(i,\mathrm{share}_i^L,\mathrm{share}_i^H)$ としてまとめる。したがって $r<k_1$ では $s_L,s_H$ のいずれも復元できず、$k_1 \le r < k_2$ では $s_L$ のみ復元できる一方で $s_H$ は情報理論的に秘匿される。$r \ge k_2$ で初めて $s_H$ が復元される。以降の実験では $n{=}5$, $(k_1,k_2)=(2,4)$ とする．言葉で言えば，収集シェア数 $r$ が $k_1$ 未満ならノイズのみ，$k_1 \le r < k_2$ なら pHash 整合ダミー，$r \ge k_2$ で原画像を復元する。この開示規則を次式で表す:
\[
  \text{output}(r) = \begin{cases}
    \text{noise} & (r < k_1) \\
    \text{dummy}(b) & (k_1 \le r < k_2) \\
    \text{original} & (r \ge k_2)
  \end{cases}
\]
ここで $\text{dummy}(b)$ は pHash 符号が $b$ と一致するノイズ画像である。
\section{三段階開示}
シェア数 $r$ に応じて、$r<k_1$ はノイズ、$k_1 \le r < k_2$ は pHash 符号一致ダミー、$r \ge k_2$ は原本を復元する。
この三段階は一度生成した同じ Shamir シェアを閾値で切り替えて出力するものであり，画像を3回別々に分割するわけではない。
\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/fig_scene_cropped.png}
  \caption{三段階 SIS の概念図（$k_1$:検索のみ，$k_2$:完全復元）}
  \label{fig:three-stage}
\end{figure}
\section{pHash 整合ダミー}
ダミー生成の流れを図\ref{fig:dummy-top3} に示す。(1) 元画像を 32$\times$32 に縮小し DCT から target bits（低周波 8$\times$8 の符号）を抽出、(2) 符号が反転しないようマージンを持たせて低周波ブロックを強調（reinforced low-freq）、(3) 高周波をランダムノイズで埋めて逆DCTし 32$\times$32 空間画像を得る。逆DCT後の符号が目標値からずれないよう、低周波振幅を複数回補強し、空間域でのわずかな変動では符号が反転しないマージンを確保する。
\section{安全性の保証範囲と評価（Shamir の保証／ダミーの可視性）}
Shamir 秘密分散は閾値未満のシェアから秘密に関する情報を与えない（情報理論的安全性）。したがって本研究では，$r<k_1$ では $s_L$（pHash 符号）と $s_H$（原画像）の双方が復元不能であること、また $k_1 \le r < k_2$ では $s_H$ が復元不能であることは Shamir の性質として保証される。一方で $k_1$ 到達時に $s_L=b$ を開示するため、低周波符号情報の漏えいが“ゼロ”であることは保証しない。以下では、開示される情報が画像内容の視認につながりにくいことを実験的指標（PSNR 等）で評価する。
低周波符号だけを拘束し高周波を完全ノイズ化することで、pHash は一致するが視覚情報は PSNR 10 dB 程度に落ち、画像内容の逆推定は本研究の評価範囲では困難と考えられる。$k_1$ 未満ではそもそも符号も一致せず平均距離 20.8 とランダムノイズ並みで、$r<k_1$ では Shamir の性質により $b$ に関する情報は得られず、設計上も秘密と独立なノイズのみを出力する。
\section{検索パイプライン}
本研究では masked SIS に特化し、平文 pHash と同一 API で (a) $k_1$ で pHash 整合ダミー検索、(b) $k_2$ で原本復元検索を切り替えるシンプルなパイプラインのみを実装する。シェアは $k_1{=}2,k_2{=}4,n{=}5$ の Shamir で分割し、生成・復元はクライアント側で完結する。

\chapter{実装}
実装は Python 3 系で構築し，数値計算に NumPy，画像処理に Pillow を用いた．外部依存はこの2つに限定し，SciPy／OpenCV や暗号・秘密分散の専用ライブラリには依存しない（環境構築の容易さと再現性を優先するため）．DCT/IDCT および Shamir 秘密分散は自前実装で補完した．
\begin{itemize}
  \item \textbf{ダミー生成}: 64bit 符号を \texttt{\_build\_lowfreq\_from\_bits} で低周波振幅に写像し、\texttt{\_reinforce\_margin} で符号反転を防ぐマージンを強制。高周波は平均0・分散$12^2$ のガウスノイズで埋め、IDCT→0–255 正規化→元サイズへ Bicubic 拡大（\texttt{make\_phash\_preserving\_dummy}）。NumPy の \texttt{default\_rng} でシード制御。
  \item \textbf{二階層 Shamir}: 大素数 $p=2^{521}-1$ 上で Lagrange 補間（\texttt{\_lagrange\_interpolate}）を行う Shamir を実装し、$n=5,k_1=2,k_2=4$ の二層分散（\texttt{TwoLevelShamirScheme}）。秘密は $p$ に収まる長さにチャンク分割して多項式係数を乱数生成し、結合時はチャンク長も保持して復元。
\end{itemize}
可視化は Matplotlib で描画し、精度・時間の集計も同一環境で自動出力している。

原画像（平文）と，SIS でシェア化して得られる $k_1$ ダミーおよび $r<k_1$ のノイズの pHash 距離を比較する（図\ref{fig:mask-phash}）。

\begin{figure}[t]
  \centering
  \includegraphics[width=\linewidth]{output/figures/phash_masked_sis/data00_tuned/stats_phash.png}
  \caption{pHash 距離の分布（原画像平文／$k_1$ ダミー／$r<k_1$ ノイズ）}
  \label{fig:mask-phash}
\end{figure}

\begin{figure}[t]
  \centering
\includegraphics[width=\linewidth]{output/figures/phash_masked_sis/data00_tuned/stats_mse.png}
  \caption{PSNR の分布（ダミーと原本）}
  \label{fig:mask-mse}
\end{figure}

\begin{figure}[t]
  \centering
\includegraphics[width=\linewidth]{output/phash_masked_sis_eval/pipeline_top3.png}
  \caption{ダミー生成トップ3（pHash 符号→強調低周波→32$\times$32 空間）}
  \label{fig:dummy-top3}
\end{figure}

\chapter{実験}
\section{条件・手順}
評価指標は Precision@k と Recall@k を用いる。オリジナル評価では各クエリの正解は同一原画像1件とし，バリアント評価では同一元画像から生成された派生画像群を正解集合とする。Precision@k は上位 k 件中の正解割合，Recall@k は正解集合のうち上位 k 件で回収できた割合である．\par

条件：COCO val2017 公式配布からシード 2025 で 500 枚をサンプリングし，20 種の固定パラメータ変換（JPEG 品質劣化，ガンマ・輝度・コントラスト，$\pm$30 度回転，リサンプリング，クロップ，ノイズ，透かし等）を適用して派生セット \texttt{coco2017\_derivatives} を作成し，パスを \texttt{mapping.json} に記録した．変換は original を含め 20 種であり，具体的には JPEG（q75, q60, q50+サブサンプリング），WebP（q70），回転±30°（黒埋め），30\%クロップ，台形射影，リサンプリング（双線形→最近傍），ガンマ 0.7/1.3，明るさ -25，コントラスト +30，ガウシアンノイズ σ=10/15，ソルト\&ペッパー 5\%，モーションブラー，透かしロゴ，矩形遮蔽である．検索は bands=8, $k{=}3,n{=}5$, $\tau{=}8$ を用い，オリジナルのみと全20バリアントの2条件で評価した．復元評価は最大 50 枚で pHash/PSNR/復元時間を測定し，500 クエリは約 0.5 ms/query で実行可能な規模として設定した．

手順：各画像について (1) 32$\times$32 グレースケール化と pHash 計算，(2) pHash 符号を保ったまま高周波をノイズ化したダミー生成，(3) 原本・ダミーを $n{=}5,(k_1,k_2)=(2,4)$ の二階層 Shamir でシェア化した．平文 pHash（plain）と $k_1$ ダミー pHash（dummy\_k1）の検索性能を比較し，復元時間と見えの指標を記録した．

\section{pHash 距離分布と精度維持の理由}
dummy\_k1でも精度が落ちないのは、pHash 符号を一致させているため Hamming 距離のランキングが平文と同一になるからである。$r<k_1$ は平均距離 20.8 で、無関係画像ペアの距離平均（約 20.8）と同程度（以下「ランダム同等」）のため候補に入らず、$k_1$ 以上の候補は平文と同じ順位付けとなる。
\section{検索精度と時間（オリジナル）}
図\ref{fig:search-original-prec}, 図\ref{fig:search-original-time} はオリジナルのみの結果。Precision@1=100\%，Precision@5=20\%，Precision@10=10\%となり、再現率@10も100\%で plain/dummy\_k1 とも同一、処理時間も 0.581 ms/query（plain）と 0.548 ms/query（dummy\_k1）でほぼ同等だった。

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_figs/precision_summary.png}
  \caption{Precision（平均値、オリジナルのみ）}
  \label{fig:search-original-prec}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_figs/time_summary.png}
  \caption{Latency（平均値、オリジナルのみ）}
  \label{fig:search-original-time}
\end{figure}

\section{バリアント別の精度と時間}
\texttt{--per\_variant\_plots} で全20バリアントを自動ループし、平文 vs ダミーの精度と時間を集計した。全バリアントの平均で Precision@1=100\%，Precision@5=86.6\%，Precision@10=84.82\%となり、再現率@10は 42.41\% と平文／ダミーが一致し、処理時間も 0.527 ms/query（plain）と 0.494 ms/query（dummy\_k1）で差が小さい（図\ref{fig:search-all-prec}, \ref{fig:search-all-time}）。

\begin{table}[t]
  \centering
  \caption{評価した20バリアントの例（mapping.json）}
  \small
  \begin{tabular}{>{\raggedright\arraybackslash}p{3.9cm} >{\raggedright\arraybackslash}p{3.9cm}}
    \hline
    フォトメトリック系 & 幾何・ノイズ系 \\
    \hline
    brightness\_minus25 & rotate\_plus30\_black \\
    contrast\_plus30 & rotate\_minus30\_black \\
    gamma\_0\_7, gamma\_1\_3 & crop\_balanced\_30 \\
    jpeg60, jpeg75, jpeg\_q50\_subs & perspective\_trapezoid \\
    webp\_q70 & resample\_bilinear\_nearest \\
    watermark\_logo & gaussian\_sigma10,15 \\
    & salt\_pepper\_5, motion\_blur \\
    & occlusion\_rectangle \\
    \hline
  \end{tabular}
\end{table}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_all_figs/precision_summary_all_variants.png}
  \caption{Precision@1（バリアント別、plain vs dummy\_k1）}
  \label{fig:search-all-prec}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.9\linewidth]{output/results/masked_phash_eval_all_figs/time_summary_all_variants.png}
  \caption{Latency（バリアント別、plain vs dummy\_k1）}
  \label{fig:search-all-time}
\end{figure}

\chapter{考察}
ダミーは、pHash を一致させつつも人が内容を視認・推測できる情報を大きく低減した状態で検索を可能にし、平文 pHash と同等の検索精度・時間を維持できた。なお $k_1$ 到達時には pHash 符号 $b$ を開示するため、低周波の符号情報が漏えいしうる点は前提として残る。一方で以下の安全性・限界を整理する。
\begin{enumerate}
  \item \textbf{視覚情報の漏えい}: pHash 整合ダミーは高周波をノイズ化するため PSNR は 10 dB 台まで低下し，視覚情報は大きく失われる．したがって内容の逆推定は本研究の評価範囲では困難と考えられる．ただし、開示されるのは低周波符号 $b$ に限定され、原画像データ $I$ の復元は $k_2$ 未満では保証されない．
  \item \textbf{pHash 距離の基準}: $k_1$ 未満では pHash も一致せず距離平均 20.8 となり，無関係画像ペアの距離平均（約 20.8）と同程度である．ここで「ランダム同等」とはこの基準と同程度であることを指す．$k_1$/$k_2$ で権限分離し，検索と復元を分けて運用できる．
  \item \textbf{アクセスパターン}: アクセスパターンは固定長バッチとダミーで平滑化するが完全には隠せない．VOPRF/TEE の導入や固定サーバ集合での一律送信が追加で必要である．
  \item \textbf{pHash の弱さ}: 大回転や 30\% 超の切り抜きで符号が崩れる弱点は残る．必要に応じて CNN 特徴や多視点 pHash とのハイブリッド化を検討する．
\end{enumerate}

\chapter{おわりに}
pHash 符号一致ダミーと二階層 Shamir に基づく三段階開示モデルを提案し、SIS 上で平文を開示せずに類似検索を実現した。平文と同等の検索性能を保ちつつ、復元コストを閾値で段階化できることを確認した。本研究は「画像を見せずに画像を検索する」という従来は両立しなかった要請に対し、pHash の知覚特性と SIS の暗号特性を統合することで実装可能性を示した点に意義がある。今後は (1) 現在の処理時間（約 0.5 ms/query）と一般的な画像検索規模を踏まえ，まず 10万件程度を現実的な初期ターゲットとしたスケールと索引・通信コストの評価、(2) pHash と CNN 特徴のハイブリッド化や頑健な知覚ハッシュとの接続、(3) クエリごとの最適 $\tau$ を動的に調整する閾値制御、(4) アクセスパターン秘匿のさらなる強化（VOPRF/TEE）を進める。優先度としては，秘匿性への影響が大きいアクセスパターン秘匿を最優先とし，次に特徴量の頑健化，その後にスケール評価と閾値最適化を進める。

\begin{thebibliography}{99}
\bibitem{Xia2020}
Z. Xia, X. Wang, L. Yao, et al., ``A privacy-preserving CBIR scheme based on secret sharing,'' \textit{IEEE Access}, 2020.
\bibitem{Zhang2024}
C. Zhang, Y. Li, and Q. Liu, ``SS-CNN: Secret sharing based secure image retrieval,'' \textit{Journal of Visual Communication and Image Representation}, 2024.
\bibitem{Barni2010}
M. Barni, P. Failla, R. Lazzeretti, et al., ``A privacy-preserving framework for JPEG-based image retrieval,'' \textit{IEEE Transactions on Information Forensics and Security}, 2010.
\bibitem{Troncoso2017}
J. R. Troncoso-Pastoriza, S. Katzenbeisser, and M. Celik, ``Privacy-preserving approximate search for multimedia,'' \textit{IEEE Transactions on Circuits and Systems for Video Technology}, 2017.
\bibitem{Tian2024}
Y. Tian, X. Wang, and D. He, ``Secure image retrieval based on feature index tree searchable encryption,'' \textit{Information Sciences}, 2024.
\bibitem{Xia2021}
Z. Xia, Y. Zhu, X. Sun, and Q. Wang, ``Searchable image encryption for privacy-preserving CBIR,'' \textit{IEEE Access}, 2021.
\bibitem{Venkatesan2000}
R. Venkatesan, S.-M. Koon, M. Jakubowski, and P. Moulin, ``Robust image hashing,'' in \textit{Proc. IEEE ICIP}, 2000.
\end{thebibliography}

\end{document}


