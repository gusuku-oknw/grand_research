# SISのディーラーフリー化

現在の `demos/demo_phash_sis.py` や `pHR_SIS` モジュールでは、ディーラー役（秘密を生成・分割・配布する中央サーバ）が存在する前提で、SIS（Secret Image Sharing）の各ステージを構成しています。具体的には Stage-1 で pHash トークンや Shamir シェアを生成し、Stage-2 で再構成や検索を行うワークフローで、OPRF／TEE／固定長パディングなどを追加することでトークンの秘匿性・通信整合性を高めていますが、依然としてディーラーが秘密生成を担っており、単一障害点のリスクは残ります。

以下ではディーラーフリー化に向けたアルゴリズムと、現在の構成との組み合わせ、効率化の余地に注目しながらまとめます。

## 1. ディーラーを排除する基本的アプローチ

1. **分散乱数生成（Distributed Randomness Generation）**  
   - Shamir シェアの係数や master secret を単一のノードではなく、複数のホルダが共同で生成する。典型的には Pedersen DKG（Distributed Key Generation）や Feldman VSS を用いて、各パーティが乱数シードを寄与し、他者の寄与を検証可能な形で合算する。
   - 現状の Stage-1 で用いる pHash トークンを複数ノードのランダムなシャアの XOR/フィールド加算で作成し、偽のディーラーに依存しない方式とする。

2. **MPC／マルチパーティ暗号による共有生成**  
   - Stage-1 のトークン生成・暗号化処理をセキュアMPCで実施し、どのノードも単独で秘密にアクセスできないようにする。例: SPDZ や MP-SPDZ 形式で秘密共有を保持したまま Shamir フィールド演算を行う。
   - OPRF を使っている Stage-1 はすでにトークンをクライアントが中心的にやり取りしているが、VOPRF 鍵を複数サーバで分割管理することで「トークン署名 (MAC) を他者と共同で生成」する設計も可能。

3. **Verifiable Secret Sharing（VSS）で生成正当性を担保**  
   - 生成されたシェアを検証できるように Pedersen commitments を Stage-1 の出力に付加する。これにより、パーティが悪意を持って歪めたトークンを送信するリスクを軽減できる。
   - 現行の HMAC や AES-GCM を補完するように実装すれば、通信後の検証／復号で改ざん検知と一貫性チェックを追加できる。

## 2. 現行構成との統合点

- **OPRF/TEE + Stage-1**  
  現在 Stage-1 で VOPRF による安全性向上を図っているが、ディーラーフリー化ではこの VOPRF の鍵を複数サーバで共有し、鍵生成および署名処理を分散実行することで「OPRF が中央で鍵を保持する」構造を排除できる。Intel SGX/TEE は同じく Stage-1 のコードを信頼実行環境で動かせば、悪意ある OS からのリークを防げる。

- **固定長パディング / 通信口数**  
  Padding や固定トークン数はステージ間の通信を均一化し、トークン差分から攻撃されにくくする。これらの工夫はディーラーフリーの拡張でも有効で、Stage-1 の出力パケットを常に同じ形式で各ノードに中継する機構（例: 改ざん検知付きの中継プロトコル）と噛み合わせられる。

- **HMAC/AES-GCM**  
  `pHR_SIS/image_store.py` にある HMAC 整合性は、複数ノードがトークン・メタデータを共有する際のインタラクションで、そのまま各ノードの MAC 検証に利用できる。分散ノードが独自に MAC キーを保持し、検証ログを共有することで、各ステージで改ざんやリプレイを検出できる。

## 3. 効率化の余地

1. **ネットワーク効率**  
   - 分散トークン生成ではペアワイズ通信が増えるため、レイヤードなバッチ処理（Stage-1 のトークンをまとめて生成し、さらに統一化されたパディングを使う）や、ネットワーク圧縮（差分エンコード、gRPC バイナリ）の導入でオーバーヘッドを抑制可能。

2. **計算効率**  
   - MPC 層においては、分散生成処理を非同期化（パーティが並列で乱数を寄与し、後処理で合算する）したり、シェア間の演算に FFT 加速を使うことで遅延を下げる。
  - Stage-2 と連携する再構成ロジックは現在の `demos/demo_phash_sis.py` から共有状態を受け取りやすいよう `pHR_SIS/index.py` 側をモジュラー化し、クライアント／サーバの責務を明確化しておく。

3. **セキュリティと検証**  
   - ディーラーフリー構成では、各ノードがどの位の `t` threshold まで耐えられるかを文書化し、現行の SIS スキーム（Shamir, pHash, HMAC）との比較で信頼性を定量化することで導入時の運用ハードルを下げられます。
   - テストベッド (`tests/fixtures` など) に分散構成向けのフィクスチャを追加し、少数ノードでの DKG/OPRF/Batched Stage-1 を再現しておけば、将来的な本番導入の移行準備となる。

## 4. 実装に向けたロードマップ案

1. Stage-1 のトークン生成を `experiments/scripts/stage_a_dkg.py` などの独立モジュールに切り出し、分散ランダムを受け取る API を用意。
2. VOPRF 鍵ペアを `pHR_SIS/oprf.py` で扱い、秘密鍵を複数シャアに分割し、クライアントの OPRF リクエストごとに分割署名（MPCベース）で処理。
3. 現行の `docs/security_improvements.mdn` などと連携しつつ、各ステージの通信・計算コストを可視化する新規グラフを追加。分散化により増えるメッセージ数をパディング/バッチ化で吸収するアイデアを併記。

これらを踏まえて、文書化・実装・テストを並行させることで、ディーラーフリー対応を段階的に進められます。ご希望であれば、この構想をもとにコード/テストやプレゼン資料のドラフトを作成しますので仰ってください。

## 5. パッケージ構成と実行例

- `pHR_SIS/` は pHash、Shamir、インデックス、イメージストアなど SIS の中核処理に限定しており、他プロジェクトからでも容易に再利用できるようにしています。  
- 実験・MPC・dealer-free に関係するロジック（`DealerFreeSimulator`、ステージ間通信のプロットなど）は `dealer_free_sis/` パッケージに移し、`pHR_SIS` 本体とは別に開発・リリースを進める構成としました。これにより「本番 SIS」対「研究・実験用ツール」の責務を明確に分離できます。  
 - `dealer_free_sis` には `run_dealer_free_experiment`（`dealer_free_sis/experiment.py`）や CLI（`dealer_free_sis/cli.py`）が含まれ、`python -m dealer_free_sis` や `experiments/scripts/dealer_free_experiment.py` で実験ジョブを起動できます。`docs/` 内の図（通信ステージや DKG オーバーヘッド）もこのパッケージの出力を前提としています。

今後の分割候補として、MPC 固有のバッチ処理や Stage-1 の分散鍵生成アルゴリズムを `dealer_free_sis/mpc/` などのサブパッケージへ移すと、さらなるモジュール化が進みます。概要図や README を追加することで、利用者が目的のコンポーネントを直感的に見つけられるように補強していきましょう。

## 6. MPC 分析モジュールの使い方

- `dealer_free_sis/mpc/__init__.py` にある `compare_secure_vs_baseline` は、同一のクエリ画像に対して `SearchableSISIndex.rank_candidates`（Baseline）と `rank_candidates_secure`（擬似MPC）を並列実行し、候補リストや距離の違いを JSON 化して出力するヘルパです。`SecureDistanceComparison` にはクエリパス、使用サーバ、選出された候補と両者の距離などが含まれるので、報告資料や論文の補助データとして使えます。
- 既存の CLI `python -m dealer_free_sis` に新たに `--mpc-query-image`（比較対象画像）、`--mpc-servers`（使用サーバID）、`--mpc-topk` / `--mpc-min-band-votes` / `--mpc-max-hamming` といったパラメタを追加し、指定すると `output/figures/dealer_free/secure_distance_comparison.json` が自動生成されます。これにより、Baseline と MPC の結果差を定量的に記録できます。

このサブパッケージをさらに拡張して `dealer_free_sis/mpc/pipeline.py` などに MPC 固有の通信計測やステージトレースを加えれば、論文用の overhead 図表をコードから直接再現するフローにできます。
